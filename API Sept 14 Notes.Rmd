---
title: "DIRECT API PULL Arkansas Covid Daily Update - County"
author: "Rob Wells"
date: "8/28/2020"
output: html_document
---

# Retrieve Arkansas Covid Data from ADH 


```{r include=FALSE}
library(tidyverse)
library(janitor)
library(lubridate)
library(tidyr)
library(httr)
library(jsonlite)

#install.packages("googledrive")
#install.packages("googlesheets4")
#library(googlesheets4)
#library("googledrive")
# vignette("basic-usage", package="googlesheets")
```


This Works. 
Question: Missing a Date Field.  
And here is the daily data
```{r}
#Old Daily County json feed
#7 Variables
q <- fromJSON('https://services.arcgis.com/PwY9ZuZRDiI5nXUB/ArcGIS/rest/services/ADH_COVID19_Positive_Test_Results/FeatureServer/0/query?where=0%3D0&objectIds=&time=&geometry=&geometryType=esriGeometryEnvelope&inSR=&spatialRel=esriSpatialRelIntersects&resultType=none&distance=0.0&units=esriSRUnit_Meter&returnGeodetic=false&outFields=county_nam%2C+positive%2C+negative%2C+Recoveries%2C+deaths%2C+total_tests%2C+active_cases&returnGeometry=false&returnCentroid=false&featureEncoding=esriDefault&multipatchOption=xyFootprint&maxAllowableOffset=&geometryPrecision=&outSR=&datumTransformation=&applyVCSProjection=false&returnIdsOnly=false&returnUniqueIdsOnly=false&returnCountOnly=false&returnExtentOnly=false&returnQueryGeometry=false&returnDistinctValues=false&cacheHint=false&orderByFields=&groupByFieldsForStatistics=&outStatistics=&having=&resultOffset=&resultRecordCount=&returnZ=false&returnM=false&returnExceededLimitFeatures=true&quantizationParameters=&sqlFormat=none&f=pjson&token=')

df <- q[["features"]][["attributes"]]
#print's today's date as a date field
#api_pull$date <- Sys.Date()
#file.exists(filename)
#austin help on that
#if file exists = check if current data is different and if that is true then append today's data set to master dataset and resave
oldcounty <- df
```

```{r}
#New County json feed
#38 Variables
q <- fromJSON('https://services.arcgis.com/PwY9ZuZRDiI5nXUB/ArcGIS/rest/services/UPDATED_ADH_COVID19_COUNTY_METRICS/FeatureServer/0/query?where=0%3D0&objectIds=&time=&geometry=&geometryType=esriGeometryEnvelope&inSR=&spatialRel=esriSpatialRelIntersects&resultType=none&distance=0.0&units=esriSRUnit_Meter&returnGeodetic=false&outFields=*&returnGeometry=true&returnCentroid=false&featureEncoding=esriDefault&multipatchOption=xyFootprint&maxAllowableOffset=&geometryPrecision=&outSR=&datumTransformation=&applyVCSProjection=false&returnIdsOnly=false&returnUniqueIdsOnly=false&returnCountOnly=false&returnExtentOnly=false&returnQueryGeometry=false&returnDistinctValues=false&cacheHint=false&orderByFields=&groupByFieldsForStatistics=&outStatistics=&having=&resultOffset=&resultRecordCount=&returnZ=false&returnM=false&returnExceededLimitFeatures=true&quantizationParameters=&sqlFormat=none&f=pjson&token=')

df3 <- q[["features"]][["attributes"]]
#print's today's date as a date field
df3$mydate <- Sys.Date()
#file.exists(filename)
#austin help on that
#if file exists = check if current data is different and if that is true then append today's data set to master dataset and resave
newcounty <- df3
```




```{r}
#Old Demographic json feed
#48 Variables
q <- fromJSON('https://services.arcgis.com/PwY9ZuZRDiI5nXUB/ArcGIS/rest/services/ADH_COVID19_State_Case_Metrics/FeatureServer/0/query?where=0%3D0&objectIds=&time=&resultType=none&outFields=*&returnIdsOnly=false&returnUniqueIdsOnly=false&returnCountOnly=false&returnDistinctValues=false&cacheHint=false&orderByFields=&groupByFieldsForStatistics=&outStatistics=&having=&resultOffset=&resultRecordCount=&sqlFormat=none&f=pjson&token=')

df2 <- q[["features"]][["attributes"]]
#print's today's date as a date field
#api_pull$date <- Sys.Date()
#file.exists(filename)
#austin help on that
#if file exists = check if current data is different and if that is true then append today's data set to master dataset and resave

olddemogr <- df2
```



```{r}
#New Demographic json feed
#58 variables
q <- fromJSON('https://services.arcgis.com/PwY9ZuZRDiI5nXUB/ArcGIS/rest/services/UPDATED_ADH_COVID19_STATE_METRICS/FeatureServer/0/query?where=0%3D0&objectIds=&time=&resultType=none&outFields=*&returnIdsOnly=false&returnUniqueIdsOnly=false&returnCountOnly=false&returnDistinctValues=false&cacheHint=false&orderByFields=&groupByFieldsForStatistics=&outStatistics=&having=&resultOffset=&resultRecordCount=&sqlFormat=none&f=pjson&token=')

df4 <- q[["features"]][["attributes"]]
#print's today's date as a date field
df4$mydate <- Sys.Date()
#file.exists(filename)
#austin help on that
#if file exists = check if current data is different and if that is true then append today's data set to master dataset and resave

newdemogr <- df4
glimpse(df4)
```


#What is different in old /new demographics
```{r}
#install.packages('arsenal')
#library(arsenal)
summary(comparedf(newdemogr, olddemogr))

```


#What is different in old /new county
```{r}
#install.packages('arsenal')
#library(arsenal)
#32 new rows of data
x<- summary(comparedf(newcounty, oldcounty))
x
```


NOTES BELOW - BUILD A NEW COUNTY TABLE

```{r}

New variables in county
OBJECTID	1	integer
x	fhwa_numbe	3	integer
x	FIPS	4	character
x	pending	7	integer
x	lab_prvt	8	integer
x	lab_pub	9	integer
x	lcase_name	13	character
x	pos_range	14	character
x	neg_range	15	character
x	border_report	16	character
x	POP_5YR_EST_2018	18	integer
x	confirmed_pos	19	integer
x	probable_pos	20	integer
x	confirmed_neg	21	integer
x	probable_neg	22	integer
x	confirmed_recov	23	integer
x	probable_recov	24	integer
x	confirmed_death	25	integer
x	probable_death	26	integer
x	confirmed_active	27	integer
x	probable_active	28	integer
x	pcr_test	29	integer
x	antigen_test	30	integer
x	pcr_pos_test	31	integer
x	pcr_neg_test	32	integer
x	antigen_pos_test	33	integer
x	antigen_neg_test	34	integer
x	total_pos_test	35	integer
x	total_neg_test	36	integer
x	Shape__Area	37	numeric
x	Shape__Length	38	numeric


```

# Part 1: Fix the data structure

- **Clean Names, Rename**

```{r}
names(old_daily_county)
```

-**QUESTION: CHECK WITH MISTY THIS IS OK -- SEEMS TO BE THE SAME THING**
Renaming county_nam - county; recoveries = recovered ; deaths = total_deaths; total_tests = current_infections

```{r}

old_daily_county  <- janitor::clean_names(old_daily_county)

  #rename(NEW NAME = EXISTING NAME) %>% 
old_daily_county  <- old_daily_county  %>% 
  rename(county = county_nam) %>% 
  rename(recovered = recoveries) %>%
  rename(total_deaths = deaths) %>%
  rename(current_infections = total_tests) 
```

Temporary Fix: Adding Date Field Until I Figure That Out
```{r}
old_daily_county  <- old_daily_county  %>% 
  mutate(date = "2020-09-13") 

old_daily_county $date <- old_daily_county (api_pull$date)
```


**Examine the Data Fields**
```{r}
glimpse(old_daily_county)
```

```{r}
names(covid)
#County data = Columns 1-24
#Hospital data = Columns 25-46
```
- **Extract Population**
```{r}
population <- rio::import("./Exercises/population.csv")
```


- **Each Day:** We join the new data, api, with the population and then perform the calculations

```{r}
daily <- api_pull %>% 
  inner_join(population, by="county")
head(daily)
```

#STOPPED HERE - REALIZED I HAVE ONLY ONE DAYS WORTH OF DATA AND CAN'T DO THE MATH


# Part 2: MATH!   

- **Now We Do The Math**
- **Previous Date Calculations**

Create Temporary Table Two Days' Worth of Data
Sort Alphbetically and Run Calculations
You should get a df with 152 observations (two days' worth a data)
```{r}
temp <- daily %>% 
  filter(date > "2020-08-17") #select YESTERDAY to get two days of data
```

```{r}
temp <- temp %>% 
  arrange(county) 
```

```{r}
glimpse(temp)
```

-**The Today-Yesterday Calculations**

    This calculates:
    Column K (New Cases Today)=J2-J3 
    Column N (Recovered Since Yesterday: =M2-M3)
    Column P (New Deaths Today: =O2-O3)
    Column R (New Tests Dashboard: =Q2-Q3)
    

```{r}
temp <- temp %>%
  mutate(new_cases_today = (positive-lead(positive))) %>%
  mutate(recovered_since_yesterday = (recovered-lead(recovered))) %>%
  mutate(new_deaths_today = (total_deaths-lead(total_deaths))) %>%
  mutate(new_tests_dashboard = (number_tested-lead(number_tested)))

temp <- temp %>% filter(date > "2020-08-18")
```


```{r}
glimpse(temp)
```

**Fact Checked: OK**
Math on the 136-139
x <- temp %>% 
  select(date, county, recovered, recovered_since_yesterday)
x
Math on 171
x <- temp %>% 
  select(date, county, pct_positive_new_today, new_cases_today,new_tests_dashboard )

```{r}
x <- temp %>% 
  select(date, county, pct_positive_new_today, new_cases_today,new_tests_dashboard )
x
```

```{r}
names(temp)
```

-**The Percentage Calculations**

This calculates
Column E (Cases/population = (positive / population) *100
Column F (Tested/population = (Number tested / population) *100
Column G (New Cases Today per 10k Population = (New Cases Today / population) *10000
Column H (Active Cases per 10k = (current_infections / population) *10000
Column T (% Positive Cumulative = (positive / Number tested) *100
Column U (% Positive New to Dashboard = New Cases Today / New Tests Dashboard) * 100
Column V (Closed = Recovered + Total Deaths)
Column W (% Deaths vs. Recoveries = Total Deaths / Closed) * 100
Column X (% Recoveries vs. Deaths = Recovered / Closed) * 100


```{r}
temp <- temp %>%
  mutate(cases_population = (positive / population)*100) %>% 
  mutate(tested_population = (number_tested / population)*100) %>% 
  mutate(new_cases_today_10k_pop = (new_cases_today/population)*10000) %>% 
  mutate(active_cases_10k_pop = (current_infections/population)*10000) %>% 
  mutate(pct_positive_cumulative = (positive/number_tested)*100) %>% 
  mutate(pct_positive_new_to_dashboard = (new_cases_today/new_tests_dashboard)*100) %>% 
  mutate(closed = (recovered + total_deaths)) %>% 
  mutate(pct_deaths_vs_recoveries = (total_deaths/closed)*100) %>% 
  mutate(pct_recoveries_vs_deaths = (recovered/closed)*100)
  
temp
```
```{r}
glimpse(temp)
```

-**This now matches Columns A-X in BeAll Sheet, DateMaster**
Hospital and state calculations in a separate sheet
```{r}
names(temp)
```

align names in order of covid table
```{r}
temp <- temp %>% 
  select(county,date,population,cases_population,tested_population,new_cases_today_10k_pop,active_cases_10k_pop,current_infections,positive, new_cases_today, negative, recovered, recovered_since_yesterday, total_deaths, new_deaths_today, number_tested, new_tests_dashboard, pct_positive_cumulative, pct_positive_new_to_dashboard, closed, pct_deaths_vs_recoveries, pct_recoveries_vs_deaths)
names(temp)
```

colnames(covid_temp)[6,7,18,19,21,22] <- c("new_cases_today_10k_pop", "active_cases_10k_pop", "pct_positive_cumulative", "pct_positive_new_to_dashboard", "pct_deaths_vs_recoveries", "pct_recoveries_vs_deaths")


# Part #3: JOINING AND ARCHIVING   

-**Update the main sheet, archiving**
```{r}
#Create a standalone copy of the TODAY'S data with the calculations
Day_8292020 <- temp
#Create a backup of the main db
covid_temp <- covid

```

RENAME COLUMNS TO MATCH NEW FILE
```{r}
covid_temp <- covid_temp %>% 
  #rename(NEW NAME = EXISTING NAME) %>% 
  rename(new_cases_today_10k_pop = new_cases_today_per_10k_population) %>% 
  rename(active_cases_10k_pop = active_cases_per_10k) %>% 
  rename(pct_positive_cumulative = percent_positive_cumulative) %>% 
  rename(pct_positive_new_to_dashboard = percent_positive_new_to_dashboard) %>% 
  rename(pct_deaths_vs_recoveries = percent_deaths_vs_recoveries) %>% 
  rename(pct_recoveries_vs_deaths = percent_recoveries_vs_deaths)
```    

This aligns DateMaster to the Day_8292020 file
```{r}
#Data cleaning and normalization. Cut state (C), new case date corrected (S) column, hospital data (Y-AT)
#Hospital data is a separate process
covid_temp <- covid_temp[ -c(3,19,25:46) ]
glimpse(covid_temp)
names(covid_temp)
```

One time cut latest day's data 
```{r}
covid_temp <- covid_temp %>% 
   filter(date < "2020-08-18")
head(covid_temp)
```

-**Join Append the New and Existing**
```{r}
covid_update <- rbind(Day_8292020,covid_temp)

```







```{r}
daily <- api %>% 
  # filter(date > "2020-08-18") %>% filtered one time for data validation - all ok
  inner_join(population1, by="county")
head(daily)
```




NORMALIZE DATES BEFORE JOINING
```{r}

daily$date <- as.Date(daily$date) 

daily1$date <- as.Date(daily1$date) 
```

```{r}
glimpse(daily)
```

```{r}
glimpse(daily2)
```
REJOIN WITH DAILY
```{r}
daily_w_calcs <- daily %>% 
  inner_join(daily2, by=c("county" = "county", "date" = "date"))
write_csv(daily_w_cals, "daily_w_calcs.csv")
```
