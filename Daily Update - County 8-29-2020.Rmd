---
title: "Arkansas Covid Daily Update - County"
author: "Rob Wells"
date: "9/3/2020"
output: pdf_document
---

# Daily Updating Arkansascovid.com County Data, Calculations

- **This notebook retrieves the daily API feed on the Austin Wilkins spreadsheet, performs all of the county calculations and rejoins it with the main DateMaster sheet.**

--**It does not handle the state and hospital calculations. That will come later**

### Retrieve Arkansas Covid Data from ADH FEED


- **The records come from Arkansascovid Google Drive**  
https://drive.google.com/drive/u/1/folders/1tsNmE6zeDdwpr6mVFacEXDOjn2RAjlJ3


- **Using this sheet: Date Master API testing**
https://docs.google.com/spreadsheets/d/16mdoWm0k3JUllm3InhoD_Jiq0lbArO_UGum8NMp9USU/edit#gid=0

--------------------------------------------------------------------
# Part 1: Fix the data structure

```{r include=FALSE}
library(tidyverse)
library(janitor)
library(lubridate)
#install.packages("googledrive")
#install.packages("googlesheets4")
library(googlesheets4)
library(googledrive)
library(tidyr)
# vignette("basic-usage", package="googlesheets")
```


-**This loads the daily county data. The source is Austin's API sheet**
```{r}
url <- ("https://docs.google.com/spreadsheets/d/16mdoWm0k3JUllm3InhoD_Jiq0lbArO_UGum8NMp9USU/edit#gid=0")

covid <- read_sheet(url)
```

-**Google Pain in the Ass Workaround**
```{r}
covid <- rio::import("THE DOWNLOADED FILE HERE")
```

- **Clean Names**
```{r}

covid <- janitor::clean_names(covid)
```

**Examine the Data Fields**
```{r}
glimpse(covid)
```

```{r}
names(covid)

```

- **Extract Population**
```{r}
population <- rio::import("./Exercises/population.csv")
```


- **Each Day:** We join the new data, api, with the population and then perform the calculations

```{r}
daily <- covid %>% 
   inner_join(population, by="county")
head(daily)
```

# Part 2: MATH!   

- **Now We Do The Math**
- **Previous Date Calculations**

Create Temporary Table Two Days' Worth of Data
Sort Alphbetically and Run Calculations
You should get a df with 150 observations (two days' worth a data)
--**Check the date is correct**

```{r}
#today's date
today <- Sys.Date()
#yesterday's date
yesterday <- (today-1)

```


```{r}
countytemp <- daily %>% 
  filter(date >= yesterday) %>%  
arrange(county) 

countytemp$date <- as.Date(countytemp$date)
countytemp$population <- as.numeric(countytemp$population)
```

```{r}
head(countytemp) 
```

```{r}
glimpse(countytemp)
```

-**The Today-Yesterday Calculations**

    This calculates:
    Column K (New Cases Today)=J2-J3 
    Column N (Recovered Since Yesterday: =M2-M3)
    Column P (New Deaths Today: =O2-O3)
    Column R (New Tests Dashboard: =Q2-Q3)
    

```{r}
countytemp <- countytemp %>%
  mutate(new_cases_today = (positive-lead(positive))) %>%
  mutate(recovered_since_yesterday = (recovered-lead(recovered))) %>%
  mutate(new_deaths_today = (total_deaths-lead(total_deaths))) %>%
  mutate(new_tests_dashboard = (number_tested-lead(number_tested)))
```

- **IMPORTANT: FILTER TABLE TO TODAY'S RESULTS**
```{r}
countytemp <- countytemp %>% filter(date > yesterday) #SHOULD GET 75 ROWS IN countytemp
```

```{r}
glimpse(countytemp)
```

-**The Percentage Calculations**

    Column E (Cases/population = (positive / population) *100
    Column F (Tested/population = (Number tested / population) *100
    Column G (New Cases Today per 10k Population = (New Cases Today / population) *10000
    Column H (Active Cases per 10k = (current_infections / population) *10000
    Column T (% Positive Cumulative = (positive / Number tested) *100
    Column U (% Positive New to Dashboard = New Cases Today / New Tests Dashboard) * 100
    Column V (Closed = Recovered + Total Deaths)
    Column W (% Deaths vs. Recoveries = Total Deaths / Closed) * 100
    Column X (% Recoveries vs. Deaths = Recovered / Closed) * 100

```{r}
countytemp <- countytemp %>%
  mutate(cases_population = (positive / population)*100) %>% 
  mutate(tested_population = (number_tested / population)*100) %>% 
  mutate(new_cases_today_10k_pop = (new_cases_today/population)*10000) %>% 
  mutate(active_cases_10k_pop = (current_infections/population)*10000) %>% 
  mutate(pct_positive_cumulative = (positive/number_tested)*100) %>% 
  mutate(pct_positive_new_to_dashboard = (new_cases_today/new_tests_dashboard)*100) %>% 
  mutate(closed = (recovered + total_deaths)) %>% 
  mutate(pct_deaths_vs_recoveries = (total_deaths/closed)*100) %>% 
  mutate(pct_recoveries_vs_deaths = (recovered/closed)*100)
  
countytemp
```

```{r}
glimpse(countytemp)
```

```{r}
glimpse(TODAY)
```

```{r}
TODAY_FOR_STATE <- TODAY %>% 
  select("County", "Date", "Positive", "Negative", "Recovered", "Total_Deaths", "Number_Tested", "Current_Infections", "Population", "New_Cases_Today", "Recovered_Since_Yesterday", "New_Deaths_Today", "New_Tests_Dashboard", "Cases_Population", "Tested_Population", "New_Cases_Today_10k_Pop", "Active_Cases_10k_Pop", "Pct_Positive_Cumulative", "Pct_Positive_New_to_Dashboard", "Closed", "Pct_Deaths_vs_Recoveries", "Pct_Recoveries_vs_Deaths")
```

**Rename data to align with Arkansascovid's Date Master BeAll sheet**

```{r}
colnames(countytemp)[1:22] <- c("County", "Date", "Positive", "Negative", "Recovered", "Total_Deaths", "Number_Tested", "Current_Infections", "Population", "New_Cases_Today", "Recovered_Since_Yesterday", "New_Deaths_Today", "New_Tests_Dashboard", "Cases_Population", "Tested_Population", "New_Cases_Today_10k_Pop", "Active_Cases_10k_Pop", "Pct_Positive_Cumulative", "Pct_Positive_New_to_Dashboard", "Closed", "Pct_Deaths_vs_Recoveries", "Pct_Recoveries_vs_Deaths")

```

-**ADD DAILY STATE TOTALS**
```{r}
countytemp <- rbind(countytemp, TODAY_FOR_STATE)
```

# Part #3: JOINING AND ARCHIVING   

-**Update the main sheet, archiving**
```{r}
#Create a standalone copy of the TODAY'S data with the calculations
TODAYCOUNTYSTATE <- countytemp %>% 
  arrange("County", "Date", "Population", "Cases_Population", "Tested_Population", "New_Cases_Today_10k_Pop", "Active_Cases_10k_Pop", "Current_Infections", "Positive",
 "New_Cases_Today", "Negative", "Recovered", "Recovered_Since_Yesterday", "Total_Deaths", "New_Deaths_Today", "Number_Tested", "New_Tests_Dashboard",
 "Pct_Positive_Cumulative", "Pct_Positive_New_to_Dashboard", "Closed", "Pct_Deaths_vs_Recoveries", "Pct_Recoveries_vs_Deaths")

TODAYCOUNTYSTATE <- as.data.frame(TODAYCOUNTYSTATE)
glimpse(TODAYCOUNTYSTATE)
```


#CUT THIS FROM THE FINAL#

- **Retrieve BeAll from DateMaster**
```{r include=FALSE}
url2 <- ("https://docs.google.com/spreadsheets/d/1g-gkjJOr1sKAu6rZHG04XA5_fM_Ma0jLr5r24fwMqiA/edit#gid=1357388768")

beall <- read_sheet(url2, sheet="BeAll")
```

```{r}
beall <- janitor::clean_names(beall)
names(beall)

```


RENAME COLUMNS TO MATCH NEW FILE
```{r}
covid_temp <- beall %>% 
  #rename(NEW NAME = EXISTING NAME) %>% 
  rename(new_cases_today_10k_pop = new_cases_today_per_10k_population) %>% 
  rename(active_cases_10k_pop = active_cases_per_10k) %>% 
  rename(pct_positive_cumulative = percent_positive_cumulative) %>% 
  rename(pct_positive_new_to_dashboard = percent_positive_new_to_dashboard) %>% 
  rename(pct_deaths_vs_recoveries = percent_deaths_vs_recoveries) %>% 
  rename(pct_recoveries_vs_deaths = percent_recoveries_vs_deaths)
```    

- **This aligns DateMaster to the Day_8292020 file**

Data cleaning and normalization. Cut state (C), new case date corrected (S) column, hospital data (Y-AT)

- **Hospital data is a separate process**



#END OF CUT#
#END OF CUT#
#END OF CUT#

-**LOAD STATE-COUNTY MASTERFILE**
```{r}
covid_temp <- rio::import("county_state_master.csv")

```


```{r}

covid_temp <- covid_temp[ -c(1) ]
glimpse(covid_temp)
names(covid_temp)
```

##not needed any longer
##not needed any longer
##not needed any longer
colnames(covid_temp)[1:22] <- c("County", "Date", "Population", "Cases_Population", "Tested_Population", "New_Cases_Today_10k_Pop", "Active_Cases_10k_Pop", "Current_Infections", "Positive",
 "New_Cases_Today", "Negative", "Recovered", "Recovered_Since_Yesterday", "Total_Deaths", "New_Deaths_Today", "Number_Tested", "New_Tests_Dashboard",
 "Pct_Positive_Cumulative", "Pct_Positive_New_to_Dashboard", "Closed", "Pct_Deaths_vs_Recoveries", "Pct_Recoveries_vs_Deaths")


-**One time - remove Sept 3 from covid_temp**

covid_temp <- covid_temp %>% 
  filter(Date < "2020-09-02")
##not needed any longer
##not needed any longer
##not needed any longer


-**Join New County-State Data and Append to Existing Master File**
-**Change the date of the file Day_9_4_2020.csv to today's day**
```{r}
county_state_master <- rbind(TODAYCOUNTYSTATE,covid_temp)
write.csv(county_state_master, "county_state_master.csv")
write.csv(TODAYCOUNTYSTATE, "Day_9_4_2020.csv")
```


##FIX MASTERFILE AND ADD STATE TOTALS FOR 9/3/2020
##FIX MASTERFILE AND ADD STATE TOTALS FOR 9/3/2020
```{r}
sept3 <- wholetable %>% 
  filter(Date==("2020-09-03"))

sept3 <- sept3 %>% 
  mutate(County = case_when(County=="Arkansas_all_counties" ~ "	Arkansas (All counties)"))
```

covid_temp_x <- covid_temp

covid_temp <- covid_temp[-c(11486), ] 

sept3$Date <- as.Date(sept3$Date)
covid_temp$Date <- as.Date(covid_temp$Date)
<-
#Remove rows with NA
newdata <- ArkCensus[-c(1,3,5), ] 
View(newdata)



```{r}
sept3 <- sept3 %>% 
  select("County", "Date", "Positive", "Negative", "Recovered", "Total_Deaths", "Number_Tested", "Current_Infections", "Population", "New_Cases_Today", "Recovered_Since_Yesterday", "New_Deaths_Today", "New_Tests_Dashboard", "Cases_Population", "Tested_Population", "New_Cases_Today_10k_Pop", "Active_Cases_10k_Pop", "Pct_Positive_Cumulative", "Pct_Positive_New_to_Dashboard", "Closed", "Pct_Deaths_vs_Recoveries", "Pct_Recoveries_vs_Deaths")
```

```{r}
covid_temp <- rbind(covid_temp, sept3)

covid_temp <- covid_temp %>% 
  arrange(("County"))
```

##FIX MASTERFILE AND ADD STATE TOTALS FOR 9/3/2020
##FIX MASTERFILE AND ADD STATE TOTALS FOR 9/3/2020



-**Side Table to Be Joined Later of Hospital Data**
```{r}
hospital <- wholetable %>% 
  select("County", "Date", "Hospitalized", "Hosp_Change_from_Yesterday", "Ever_Hospitalized","New_Admits", "New_Discharges_Deaths","Pct_Hospitalized","Vent","Ever_on_a_Vent","New_on_Vent","Pct_Vent")

```

-**Create Separate Hospital Table**
```{r}
write.csv(hospital, "hospital_test.csv")

```

-**Cannot Seem to Join the Hospital Table, which has only state data, to the covid_update table, which has counties and state data**

**This joins the tables but the hospital data is missing**
```{r}
master <- covid_update %>% 
  left_join(hospital, by=c("Date", "County"))

```



```{r}
master <- merge(covid_update, hospital, by="Date", "County", all.x=TRUE)
```

```{r}
glimpse(hospital)
```

```{r}
glimpse(covid_update)
```

```{r}
wholetable2 <- wholetable[ -c(23:32) ]
```

-**Join with wholetable**
```{r}
wholetable3 <- rbind(wholetable2, TODAYCOUNTY)
```


**30**
