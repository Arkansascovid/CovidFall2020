---
title: "State Daily Update Arkansas Covid"
author: "Rob Wells"
date: "9/3/2020"
output: pdf_document
---

# State Data Daily Update Arkansascovid.com Calculations

- **This notebook retrieves data from a Google sheet, performs all of the county calculations and rejoins it with the main DateMaster sheet.**

--**County Calculations On Separate Script**

### Retrieve State Arkansas Covid Data from ADH FEED

- **Using this sheet: Copy Date Master API testing**
https://docs.google.com/spreadsheets/d/1ikblX8tikM59ma1AftkqgGbyeZkXB6DuBtwMsVeoGYw/edit#gid=701586163

--------------------------------------------------------------------
# Part 1: Fix the data structure

```{r include=FALSE}
library(tidyverse)
library(janitor)
library(lubridate)
#install.packages("googledrive")
#install.packages("googlesheets4")
library(googlesheets4)
library(googledrive)
library(tidyr)
# vignette("basic-usage", package="googlesheets")
```

**Read in State Data from Google Sheet**

```{r}
url <- ("https://docs.google.com/spreadsheets/d/1ikblX8tikM59ma1AftkqgGbyeZkXB6DuBtwMsVeoGYw/edit#gid=701586163")

state <- read_sheet(url, sheet = "Form Responses 1",  na = "")
```



- **Clean Names**
```{r}

state <- janitor::clean_names(state)
```

- **Cleaning: Convert data from List variables to numeric**
```{r include=FALSE}
state$recoveries_recovered <- as.numeric(state$recoveries_recovered)
state$cases_added_today_new_cases_today <- as.numeric(state$cases_added_today_new_cases_today)
state$hospitalized <- as.numeric(state$hospitalized)
state$on_ventilators_vent <- as.numeric(state$on_ventilators_vent)
state$ever_hospitalized_ever_hospitalized <- as.numeric(state$ever_hospitalized_ever_hospitalized)
state$ever_on_ventilator_ever_on_a_vent  <- as.numeric(state$ever_on_ventilator_ever_on_a_vent)
state$total_deaths_total_deaths  <- as.numeric(state$total_deaths_total_deaths)
state$total_cases_positive  <- as.numeric(state$total_cases_positive)
state$active_cases_current_infections  <- as.numeric(state$active_cases_current_infections)
state$total_negative_tests_reported_negatives <- as.numeric(state$total_negative_tests_reported_negatives) 

```

```{r}
glimpse(state)
```

**Rename data to align with Arkansascovid's Date Master BeAll sheet**

```{r}
colnames(state)[2:12] <- c("Date", "Recovered","New_Cases_Today", "Hospitalized","Vent", "Ever_Hospitalized", "Ever_on_a_Vent", "Total_Deaths",
"Positive", "Current_Infections", "Negative")

```


- **Add State Population, Convert to dataframe**
```{r}
state <- state %>% 
  mutate(Population ="3017804")

state$Population <- as.numeric(state$Population)
#cut timestamp column
state <- state[ -c(1) ]
#convert date field
state$Date <- as.Date(state$Date)
#create dataframe
state <- as.data.frame(state)

state <- state %>% 
  arrange(desc("Date"))  
```

```{r} 
glimpse(state)
```

-**Create Number Tested Field**
```{r}
state <- state %>% 
  mutate(Number_Tested=(Positive+Negative)) %>% 
  arrange(desc(Date))

```

# Part 2: MATH!   

- **Now We Do The Math**
- **Previous Date Calculations**

Create Temporary Table Two Days' Worth of Data
Sort Alphbetically and Run Calculations
You should get a df with 150 observations (two days' worth a data)

--**Check the date is correct**

```{r}
#today's date
today <- Sys.Date()
#yesterday's date
yesterday <- (today-1)

```

--**Check the dates are correct and that the data is filtered for today, yesterday**

```{r}
twodays <- state %>% 
  filter(Date >= yesterday) %>%  #get two days' of data
arrange(desc(Date)) 
```

```{r}
head(twodays) 
```


-**The Today-Yesterday Calculations**

    This calculates:
    Column K (New Cases Today)=J2-J3 
    Column N (Recovered Since Yesterday: =M2-M3)
    Column P (New Deaths Today: =O2-O3)
    Column R (New Tests Dashboard: =Q2-Q3)
    Column Z (hosp_change_from_yesterday: Hospitals -(yesterday) Hospitals
    Column AB (new_admits = ever_hospitalized-(yesterday) ever_hospitalized)
    Column AC (new_discharges_deaths = Hospital change- new admits)
    Column AD (pct_hospitalized = hospitalized / current infections) * 100
    Column AG (new_on_vent = ever_on_a_vent - (yesterday) ever_on_a_vent
    Column AH (pct_vent = vent / hospitalized) * 100                  

```{r}
temp <- twodays %>%
  mutate(New_Cases_Today = (Positive-lead(Positive))) %>%
  mutate(Recovered_Since_Yesterday = (Recovered-lead(Recovered))) %>%
  mutate(New_Deaths_Today = (Total_Deaths-lead(Total_Deaths))) %>%
  mutate(New_Tests_Dashboard = (Number_Tested-lead(Number_Tested))) %>% 
  mutate(Hosp_Change_from_Yesterday = (Hospitalized-lead(Hospitalized))) %>% 
  mutate(New_Admits = (Ever_Hospitalized-lead(Ever_Hospitalized))) %>% 
  mutate(New_Discharges_Deaths = (New_Admits-Hosp_Change_from_Yesterday)) %>% 
  mutate(Pct_Hospitalized = (Hospitalized/Current_Infections)*100) %>% 
  mutate(New_on_Vent = (Ever_on_a_Vent-lead(Ever_on_a_Vent))) %>% 
  mutate(Pct_Vent = (Vent/Hospitalized)*100) 
```

```{r}
glimpse(temp)
```

-**More Percentage Calculations**

    Column E (Cases/population = (positive / population) *100
    Column F (Tested/population = (Number tested / population) *100
    Column G (New Cases Today per 10k Population = (New Cases Today / population) *10000
    Column H (Active Cases per 10k = (current_infections / population) *10000
    Column T (% Positive Cumulative = (positive / Number tested) *100
    Column U (% Positive New to Dashboard = New Cases Today / New Tests Dashboard) * 100
    Column V (Closed = Recovered + Total Deaths)
    Column W (% Deaths vs. Recoveries = Total Deaths / Closed) * 100
    Column X (% Recoveries vs. Deaths = Recovered / Closed) * 100

```{r}
temp <- temp %>%
  mutate(Cases_Population = (Positive / Population)*100) %>% 
  mutate(Tested_Population = (Number_Tested / Population)*100) %>% 
  mutate(New_Cases_Today_10k_Pop = (New_Cases_Today/Population)*10000) %>% 
  mutate(Active_Cases_10k_Pop = (Current_Infections/Population)*10000) %>% 
  mutate(Pct_Positive_Cumulative = (Positive/Number_Tested)*100) %>% 
  mutate(Pct_Positive_New_to_Dashboard = (New_Cases_Today/New_Tests_Dashboard)*100) %>% 
  mutate(Closed = (Recovered + Total_Deaths)) %>% 
  mutate(Pct_Deaths_vs_Recoveries = (Total_Deaths/Closed)*100) %>% 
  mutate(Pct_Recoveries_vs_Deaths = (Recovered/Closed)*100) %>% 
  mutate(County = "Arkansas_all_counties")
  
temp
```

```{r}
glimpse(temp)
```

- **Align names in order of covid table**
```{r}
temp <- temp %>% 
  select(County, Date, Population, Cases_Population,Tested_Population,New_Cases_Today_10k_Pop,Active_Cases_10k_Pop,Current_Infections,Positive, New_Cases_Today, Negative, Recovered, Recovered_Since_Yesterday, Total_Deaths, New_Deaths_Today, Number_Tested, New_Tests_Dashboard, Pct_Positive_Cumulative, Pct_Positive_New_to_Dashboard, Closed, Pct_Deaths_vs_Recoveries, Pct_Recoveries_vs_Deaths, Hospitalized, Hosp_Change_from_Yesterday, Ever_Hospitalized, New_Admits, New_Discharges_Deaths, Pct_Hospitalized, Vent, Ever_on_a_Vent, New_on_Vent, Pct_Vent)
names(temp)
```


# Part #3: JOINING AND ARCHIVING   

-**Update the main sheet, archiving**
```{r}
#Create a standalone copy of the TODAY'S data with the calculations
TODAY <- temp %>% 
  filter(Date > yesterday)
glimpse(TODAY)
```
-**Import Whole Table**
#IMPORTANT - CHECK THIS TABLE HAS YESTERDAY'S DATA
```{r}
wholetable <- rio::import("all_state_and_hospitals_9_3_2020.csv")
```

```{r}
glimpse(wholetable)
```
-**Fix Date, Eliminate V1 index**
```{r}
wholetable$Date <- as.Date(wholetable$Date)
#cut timestamp column
wholetable <- wholetable[ -c(1) ]
```

-**Join with Wholetable**
```{r}
wholetable <- rbind(wholetable, TODAY)

wholetable <- wholetable %>% 
  arrange(desc(Date))
```


```{r}
head(wholetable)
```

-**Change File Name to Today's Date**

```{r}
write.csv(wholetable, "all_state_and_hospitals.csv")
```


-**30**