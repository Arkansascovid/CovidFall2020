---
title: "Demographic Update Arkansas Covid"
author: "Rob Wells. Thanks to Mary Hennigan for assistance"
date: "11/02/2020"
output: pdf_document
---

# Demographic Daily Update Arkansascovid.com Calculations

# Part 1: Import Data, Clean It

```{r include=FALSE}
#install.packages("slider")
#install.packages("zoo")
#install.packages("gtools")
# vignette("basic-usage", package="googlesheets")
#install.packages("googledrive")
#install.packages("googlesheets4")
library(tidyverse)
library(janitor)
library(lubridate)
#library(googlesheets4)
#library(googledrive)
library(tidyr)
library(jsonlite)
library(gtools)
library(zoo)  
library(reshape2)
library(slider)

```

## Retrieve State Arkansas Covid Data from ADH FEED
```{r}
#New County json feed
#38 Variables
z <- fromJSON('https://services.arcgis.com/PwY9ZuZRDiI5nXUB/ArcGIS/rest/services/UPDATED_ADH_COVID19_STATE_METRICS/FeatureServer/0/query?where=0%3D0&objectIds=&time=&resultType=none&outFields=*&returnIdsOnly=false&returnUniqueIdsOnly=false&returnCountOnly=false&returnDistinctValues=false&cacheHint=false&orderByFields=&groupByFieldsForStatistics=&outStatistics=&having=&resultOffset=&resultRecordCount=&sqlFormat=none&f=pjson&token=')

df <- z[["features"]][["attributes"]]
#print's today's date as a date field
df$date <- Sys.Date()
#file.exists(filename)
#austin help on that
#if file exists = check if current data is different and if that is true then append today's data set to master dataset and resave
today_demo <- df
```

#This is the API feed. It is called "today_demo" for demographics. Get it?
```{r}
today_demo <- janitor::clean_names(today_demo)
#if you miss a date, uncomment below and use this
#today_demo$date <- ("2020-11-01")
```


#Set Dates
```{r}
#today's date
today <- Sys.Date()

#NOTE: IF YOU ARE RUNNING THIS A DAY LATE, USE THIS CODE TO WORK PROPERLY
#today <- Sys.Date()-1
#today_demo$mydate <-"2020-09-22- THE OLD DATE...."

#yesterday's date
yesterday <- (today-1)


glimpse(today_demo)
```

#Cleaning Names, Converting to Numeric Variables
```{r}
#today_demo <- today_demo [ -c(1) ]
today_demo [2:58] <- lapply(today_demo [2:58], as.numeric)
today_demo$date <- as.Date(today_demo$date)
glimpse(today_demo)
```
```{r}
glimpse(today_demo)
```


#Rename Variables
```{r}
colnames(today_demo)[1:59] <-c("Objectid","Fips","Black", "White", "Na", 
 "Asian", "Pi","Other_Race","Unk_Race","Multi_Race", 
 "Nonhispanic", "Hispanic","Deaths_Black", "Deaths_White", "Deaths_Na", 
"Deaths_Asian", "Deaths_Pi","Deaths_Other_Race","Deaths_Unk_Race","Deaths_Multi_Race", 
"Cases_0_10", "Cases_11_17", "Cases_18_24", "Cases_25_34", "Cases_35_44", "Deaths_0_10"   
, "Deaths_11_17", "Deaths_18_24", "Deaths_25_34", "Deaths_35_44", "Male","Female","Unk_Gender","Diabetes","Cardiac_Disease",
"Hypertension","Cpd", "Ckd", "Immunocompromised", "Healthcare", 
"Nursing_Home","Jailed","Positives", "Deaths_Nursing_Home","Deaths_Jailed", 
"Deaths", "Deaths_Hispanic", "Deaths_Nonhispanic", "Cases_45_54", "Deaths_45_54", "Cases_55_64", "Deaths_55_64", "Cases_65", "Deaths_65", 
"Noncovid_Death", "Pos_24Hr", "Cases_Unknown", "Deaths_Unknown","Date")

glimpse(today_demo)
```

#----------------------------------------------------------------------------------------------------#
#----------------------------------------------------------------------------------------------------#
#AGE calculations
#----------------------------------------------------------------------------------------------------#
#----------------------------------------------------------------------------------------------------#
#Today's data with age
```{r}
today_age <- today_demo %>% 
  select("Date", 
 "Cases_0_10"   
, "Cases_11_17" 
, "Cases_18_24" 
, "Cases_25_34" 
, "Cases_35_44" 
, "Deaths_0_10"    
, "Deaths_11_17"    
, "Deaths_18_24"    
, "Deaths_25_34"    
, "Deaths_35_44"
, "Cases_45_54" 
, "Deaths_45_54"    
, "Cases_55_64" 
, "Deaths_55_64"              
, "Cases_65"                               
, "Deaths_65"                        
, "Cases_Unknown"                               
, "Deaths_Unknown" )
glimpse(today_age)
```

#Rename

```{r}
# today_age2 <- today_age
# 
# colnames(today_age2)[2:19] <-c("cases_0_10", "cases_11_17", "cases_18_24", "cases_25_34", "cases_35_44", "cases_45_54", "cases_55_64", "cases_65", "cases_unknown", "deaths_0_10", "deaths_11_17", "deaths_18_24", "deaths_25_34", "deaths_35_44", "deaths_45_54", "deaths_55_64", "deaths_65", "deaths_unknown")
# today_age2$date <- as.Date(today_age2$date)
# glimpse(today_age2)
```

#Today_yesterday
#Import age master file
```{r}
age3 <- rio::import("https://raw.githubusercontent.com/Arkansascovid/Main/master/age_master.csv")

#age3 <- janitor::clean_names(age3)
#age3$date <- mdy(age3$date)
#age3 <- age3[ -c(1,2,3) ]
glimpse(age3)
#write.csv(age3, "age3.csv")
```

```{r}
yesterday_age <- age3 %>% 
   select("Date", "Cases_0_10", "Cases_11_17", "Cases_18_24", "Cases_25_34", "Cases_35_44", "Cases_45_54", "Cases_55_64", "Cases_65", "Cases_Unknown", "Deaths_0_10", "Deaths_11_17", "Deaths_18_24", "Deaths_25_34", "Deaths_35_44", "Deaths_45_54", "Deaths_55_64", "Deaths_65", "Deaths_Unknown") %>% 
  filter(Date==yesterday)

#if you miss a day, fill this out and run instead
#filter(date == "2020-10-19") %>% 

 yesterday_age$Date <- as.Date(yesterday_age$Date)
 glimpse(yesterday_age)
```



#This creates a df with 2 observations (two days' worth a data)
```{r}
twodays <- rbind(today_age, yesterday_age)
glimpse(twodays)

```


-**The Today-Yesterday Calculations**

```{r}
twodays <- twodays %>%
   mutate(New_Cases_0_10 = (Cases_0_10-lead(Cases_0_10))) %>% 
  mutate(New_Cases_11_17 = (Cases_11_17-lead(Cases_11_17))) %>% 
  mutate(New_Cases_18_24 = (Cases_18_24-lead(Cases_18_24))) %>% 
  mutate(New_Cases_25_34 = (Cases_25_34-lead(Cases_25_34))) %>%  
  mutate(New_Cases_35_44 = (Cases_35_44-lead(Cases_35_44))) %>%  
  mutate(New_Cases_45_54 = (Cases_45_54-lead(Cases_45_54))) %>%
  mutate(New_Cases_55_64 = (Cases_55_64-lead(Cases_55_64))) %>%
  mutate(New_Cases_65 = (Cases_65-lead(Cases_65))) %>% 
  mutate(New_Deaths_0_10 = (Deaths_0_10-lead(Deaths_0_10))) %>% 
  mutate(New_Deaths_11_17 = (Deaths_11_17-lead(Deaths_11_17))) %>% 
  mutate(New_Deaths_18_24 = (Deaths_18_24-lead(Deaths_18_24))) %>% 
  mutate(New_Deaths_25_34 = (Deaths_25_34-lead(Deaths_25_34))) %>%  
  mutate(New_Deaths_35_44 = (Deaths_35_44-lead(Deaths_35_44))) %>%  
  mutate(New_Deaths_45_54 = (Deaths_45_54-lead(Deaths_45_54))) %>%
  mutate(New_Deaths_55_64 = (Deaths_55_64-lead(Deaths_55_64))) %>%
  mutate(New_Deaths_65 = (Deaths_65-lead(Deaths_65))) 
```

#Creates one day with Today's calculations only
```{r}
today_age_calcs <- twodays %>% 
    filter(Date ==today)
  #if you miss a day, fill this out and run instead
  #filter(date == "2020-10-14") 

#today_age_calcs <- janitor::clean_names(today_age_calcs)
glimpse(today_age_calcs)
```

```{r}
age4 <- smartbind(age3, today_age_calcs)

age4 <- age4 %>% 
  arrange(desc(Date))

age4 <- slice(age4, -c(1))
#remove first two columns of garbage index if needed
#age4 <- age4[ -c(1) ]

write.csv(age4, "age_master.csv")

```


#Create age_FLOURISH_master
#Rename variables 
```{r}
age4 <- age4 %>% 
  filter(Date >= "2020-09-13")

write.csv(age4, "age_FLOURISH_master.csv")

```


#New Cases Today Table for Flourish
```{r}
age_new_cases <- age4 %>% 
  select(Date, New_Cases_0_10, New_Cases_11_17, New_Cases_18_24, New_Cases_25_34, New_Cases_35_44, New_Cases_45_54, New_Cases_55_64, New_Cases_65) %>% 
  filter(Date == today) %>% 
  distinct()

#flip
age_new_cases <- gather(age_new_cases, key = "Age", value = "New_Cases", New_Cases_0_10, New_Cases_11_17, New_Cases_18_24, New_Cases_25_34, New_Cases_35_44, New_Cases_45_54, New_Cases_55_64, New_Cases_65)

age_new_cases
write.csv(age_new_cases, "age_new_cases.csv")

```

#New Deaths Today Table for Flourish
```{r}
age_new_deaths <- age4 %>% 
  select(Date, New_Deaths_0_10, New_Deaths_11_17, New_Deaths_18_24,  New_Deaths_25_34, New_Deaths_35_44, New_Deaths_45_54, New_Deaths_55_64, New_Deaths_65) %>% 
  filter(Date == today) %>% 
  distinct()

#flip
age_new_deaths <- gather(age_new_deaths, key = "Age", value = "New_Deaths", New_Deaths_0_10, New_Deaths_11_17, New_Deaths_18_24,  New_Deaths_25_34, New_Deaths_35_44, New_Deaths_45_54, New_Deaths_55_64, New_Deaths_65)

age_new_deaths
write.csv(age_new_deaths, "age_new_deaths.csv")

```
#Combine age_new_deaths and age_new_cases

```{r}
#SF$disposition1 <- str_replace_all(SF$disposition1, pattern=fixed('ABA'), replacement=fixed('Abated') )
#strip the race name down
age_new_cases$NEW <- str_replace_all(age_new_cases$Age, pattern=fixed('New_Cases_'), replacement=fixed('Age_'))
age_new_deaths$NEW <- str_replace_all(age_new_deaths$Age, pattern=fixed('New_Deaths_'), replacement=fixed('Age_'))

```

```{r}
age_new_cases_deaths <- age_new_cases %>% 
   inner_join(age_new_deaths, by=c("NEW", "Date"))

age_new_cases_deaths <- age_new_cases_deaths %>% 
  select(Date, NEW, New_Cases, New_Deaths)

colnames(age_new_cases_deaths)[2] <- "Age"
head(age_new_cases_deaths)

write.csv(age_new_cases_deaths, "age_new_cases_deaths.csv")
```



#----------------------------------------------------------------------------------------------------#
#----------------------------------------------------------------------------------------------------#
#RACE calculations
#----------------------------------------------------------------------------------------------------#
#----------------------------------------------------------------------------------------------------#
#Today's data with race
#----------------------------------------------------------------------------------------------------#
#----------------------------------------------------------------------------------------------------#
#RACE calculations
#----------------------------------------------------------------------------------------------------#
#----------------------------------------------------------------------------------------------------#
#Today's data with race

```{r}
today_race <- today_race %>%
  rename(Cases_African_American=Black,
Cases_White=White,
Cases_Asian=Asian,
Cases_Pacific_Islander=Pi,
Cases_Other=Other_Race,
Cases_Race_Or_Ethnicity_Unknown=Unk_Race,
Cases_Multi_Racial=Multi_Race,
Cases_Hispanic=Hispanic,
Deaths_African_American=Deaths_Black,
Deaths_White=Deaths_White,
Deaths_Asian=Deaths_Asian,
Deaths_Pacific_Islander=Deaths_Pi,
Deaths_Other_Race=Deaths_Other_Race,
Deaths_Race_Or_Ethnicity_Unknown=Deaths_Unk_Race,
Deaths_Multi_Racial=Deaths_Multi_Race,
Deaths_Hispanic=Deaths_Hispanic)

glimpse(today_race)
```

#Today_yesterday
#Import the master file for race from GitHub

```{r}
race3 <- rio::import("https://raw.githubusercontent.com/Arkansascovid/Main/master/race_main_file.csv")
#race3 <- janitor::clean_names(race3)
race3$date <- as.Date(race3$date)

race3 <- race3 %>% 
  rename(Date = date,
Cases_African_American = cases_african_american,
Cases_Asian = cases_asian,
Cases_Hispanic = cases_hispanic,
Cases_Multi_Racial = cases_multi_racial,
Cases_Native_American = cases_native_american,
Cases_Pacific_Islander = cases_pacific_islander,
Cases_White = cases_white,
Cases_Other = cases_other,
Cases_Race_Or_Ethnicity_Unknown = cases_race_or_ethnicity_unknown,
New_Cases_African_American = new_cases_african_american,
New_Cases_Asian = new_cases_asian,
New_Cases_Hispanic = new_cases_hispanic,
New_Cases_Multi_Racial = new_cases_multi_racial,
New_Cases_Native_American = new_cases_native_american,
New_Cases_Pacific_Islander = new_cases_pacific_islander,
New_Cases_White = new_cases_white,
New_Cases_Other = new_cases_other,
New_Cases_Race_Or_Ethnicity_Unknown = new_cases_race_or_ethnicity_unknown,
Deaths_African_American = deaths_african_american,
Deaths_Asian = deaths_asian,
Deaths_Hispanic = deaths_hispanic,
Deaths_Multi_Racial = deaths_multi_racial,
Deaths_Native_American = deaths_native_american,
Deaths_Pacific_Islander = deaths_pacific_islander,
Deaths_White = deaths_white,
Deaths_Other = deaths_other,
Deaths_Race_Or_Ethnicity_Unknown = deaths_race_or_ethnicity_unknown,
New_Deaths_African_American = new_deaths_african_american,
New_Deaths_Asian = new_deaths_asian,
New_Deaths_Hispanic = new_deaths_hispanic,
New_Deaths_Multi_Racial = new_deaths_multi_racial,
New_Deaths_Native_American = new_deaths_native_american,
New_Deaths_Pacific_Islander = new_deaths_pacific_islander,
New_Deaths_White = new_deaths_white,
New_Deaths_Other = new_deaths_other,
New_Deaths_Race_Or_Ethnicity_Unknown = new_deaths_race_or_ethnicity_unknown,
Total_State_Population_African_American = total_state_population_african_american,
Total_State_Population_Asian = total_state_population_asian,
Total_State_Population_Hispanic = total_state_population_hispanic,
Total_State_Population_Multi_Racial = total_state_population_multi_racial,
Total_State_Population_Native_American = total_state_population_native_american,
Total_State_Population_Pacific_Islander = total_state_population_pacific_islander,
Total_State_Population_White = total_state_population_white,
Total_State_Population_Other = total_state_population_other,
Total_State_Population_Race_Or_Ethnicity_Unknown = total_state_population_race_or_ethnicity_unknown,
Pct_State_Population_African_American = pct_state_population_african_american,
Pct_State_Population_Asian = pct_state_population_asian,
Pct_State_Population_Hispanic = pct_state_population_hispanic,
Pct_State_Population_Multi_Racial = pct_state_population_multi_racial,
Pct_State_Population_Native_American = pct_state_population_native_american,
Pct_State_Population_Pacific_Islander = pct_state_population_pacific_islander,
Pct_State_Population_White = pct_state_population_white,
Pct_State_Population_Other = pct_state_population_other,
Pct_State_Population_Race_Or_Ethnicity_Unknown = pct_state_population_race_or_ethnicity_unknown,
Cases_Per_10_000_African_American = cases_per_10_000_african_american,
Cases_Per_10_000_Asian = cases_per_10_000_asian,
Cases_Per_10_000_Hispanic = cases_per_10_000_hispanic,
Cases_Per_10_000_Multi_Racial = cases_per_10_000_multi_racial,
Cases_Per_10_000_Native_American = cases_per_10_000_native_american,
Cases_Per_10_000_Pacific_Islander = cases_per_10_000_pacific_islander,
Cases_Per_10_000_White = cases_per_10_000_white,
Cases_Per_10_000_Other = cases_per_10_000_other,
Cases_Per_10_000_Race_Or_Ethnicity_Unknown = cases_per_10_000_race_or_ethnicity_unknown,
Deaths_Per_10_000_African_American = deaths_per_10_000_african_american,
Deaths_Per_10_000_Asian = deaths_per_10_000_asian,
Deaths_Per_10_000_Hispanic = deaths_per_10_000_hispanic,
Deaths_Per_10_000_Multi_Racial = deaths_per_10_000_multi_racial,
Deaths_Per_10_000_Native_American = deaths_per_10_000_native_american,
Deaths_Per_10_000_Pacific_Islander = deaths_per_10_000_pacific_islander,
Deaths_Per_10_000_White = deaths_per_10_000_white,
Deaths_Per_10_000_Other = deaths_per_10_000_other,
Deaths_Per_10_000_Race_Or_Ethnicity_Unknown = deaths_per_10_000_race_or_ethnicity_unknown,
Cases_Other_Race = cases_other_race,
Cases_Unknown_Race = cases_unknown_race,
Deaths_Other_Race = deaths_other_race,
Deaths_Unknown_Race = deaths_unknown_race)

glimpse(race3)
```


```{r}
race3 <- as.data.frame(race3)
yesterday_race <- race3 %>% 
  select("Date", "Cases_African_American", "Cases_White", "Cases_Native_American", "Cases_Asian", "Cases_Pacific_Islander", "Cases_Hispanic", "Cases_Multi_Racial", "Deaths_African_American", "Deaths_White", "Deaths_Native_American", "Deaths_Asian", "Deaths_Pacific_Islander", "Deaths_Hispanic", "Deaths_Multi_Racial", "Total_State_Population_African_American", "Total_State_Population_Asian", "Total_State_Population_Hispanic", "Total_State_Population_Multi_Racial", "Total_State_Population_Native_American",
"Total_State_Population_Pacific_Islander", "Total_State_Population_White",  "Total_State_Population_Other", "Total_State_Population_Race_Or_Ethnicity_Unknown", "Pct_State_Population_African_American",  "Pct_State_Population_Asian", "Pct_State_Population_Hispanic", "Pct_State_Population_Multi_Racial",  "Pct_State_Population_Native_American", "Pct_State_Population_Pacific_Islander", 
"Pct_State_Population_White", "Pct_State_Population_Other", "Pct_State_Population_Race_Or_Ethnicity_Unknown") %>% 
    filter(Date == yesterday)


#if you miss a day, fill this out and run instead
# filter(date == "2020-10-13") %>% 

yesterday_race$Date <- as.Date(yesterday_race$Date)
glimpse(yesterday_race)
```

#Create a population table
```{r}
pop <- race3 %>% 
  select("Date", "Total_State_Population_African_American", "Total_State_Population_Asian", "Total_State_Population_Hispanic", "Total_State_Population_Multi_Racial", "Total_State_Population_Native_American",
"Total_State_Population_Pacific_Islander", "Total_State_Population_White",  "Total_State_Population_Other", "Total_State_Population_Race_Or_Ethnicity_Unknown", "Pct_State_Population_African_American",  "Pct_State_Population_Asian", "Pct_State_Population_Hispanic", "Pct_State_Population_Multi_Racial",  "Pct_State_Population_Native_American", "Pct_State_Population_Pacific_Islander", 
"Pct_State_Population_White", "Pct_State_Population_Other", "Pct_State_Population_Race_Or_Ethnicity_Unknown") %>% 
  filter(Date == yesterday) 

#if you miss a day, fill this out and run instead
#filter(date == "2020-10-13") %>% 
#
#Change to today's date
pop$Date <- today
#if you miss a day, fill this out and run instead
#pop$date <- "2020-10-14"

pop$Date <- as.Date(pop$Date)
glimpse(pop)
```


```{r}
today_race2 <- today_race %>% 
   left_join(pop, by="Date")
head(today_race2)
```

#You should get a df with 2 observations (two days' worth a data)
```{r}
twodays2 <- smartbind(today_race2, yesterday_race)
twodays2$Date <- as.Date(twodays2$Date)
glimpse(twodays2)

```

-**The Today-Yesterday Calculations**

```{r}
twodays3 <- twodays2 %>%
  mutate(New_Cases_African_American = (Cases_African_American-lead(Cases_African_American))) %>% 
  mutate(New_Cases_White = (Cases_White-lead(Cases_White))) %>% 
   mutate(New_Cases_Native_American = (Cases_Native_American-lead(Cases_Native_American))) %>%
   mutate(New_Cases_Asian = (Cases_Asian-lead(Cases_Asian))) %>%
   mutate(New_Cases_Pacific_Islander = (Cases_Pacific_Islander-lead(Cases_Pacific_Islander))) %>%
   mutate(New_Cases_Hispanic = (Cases_Hispanic-lead(Cases_Hispanic))) %>%
   mutate(New_Cases_Multi_Racial = (Cases_Multi_Racial-lead(Cases_Multi_Racial))) %>%
   mutate(New_Deaths_African_American = (Deaths_African_American-lead(Deaths_African_American))) %>%
   mutate(New_Deaths_White = (Deaths_White-lead(Deaths_White))) %>%
   mutate(New_Deaths_Native_American = (Deaths_Native_American-lead(Deaths_Native_American))) %>%
   mutate(New_Deaths_Asian = (Deaths_Asian-lead(Deaths_Asian))) %>%
   mutate(New_Deaths_Pacific_Islander = (Deaths_Pacific_Islander-lead(Deaths_Pacific_Islander))) %>%
   mutate(New_Deaths_Hispanic = (Deaths_Hispanic-lead(Deaths_Hispanic))) %>%
   mutate(New_Deaths_Multi_Racial = (Deaths_Multi_Racial-lead(Deaths_Multi_Racial))) 
```

#Percentage Calculations 
```{r}
twodays3 <- twodays3 %>%
mutate(Cases_Per_10_000_African_American = (Cases_African_American / Total_State_Population_African_American)*10000) %>% 
mutate(Cases_Per_10_000_Asian = (Cases_Asian / Total_State_Population_Asian)*10000) %>% 
mutate(Cases_Per_10_000_Multi_Racial = (Cases_Multi_Racial / Total_State_Population_Multi_Racial)*10000) %>%
mutate(Cases_Per_10_000_Pacific_Islander = (Cases_Pacific_Islander / Total_State_Population_Pacific_Islander)*10000) %>%
mutate(Cases_Per_10_000_Hispanic = (Cases_Hispanic / Total_State_Population_Hispanic)*10000) %>%
mutate(Cases_Per_10_000_Native_American = (Cases_Native_American / Total_State_Population_Native_American)*10000) %>%
mutate(Cases_Per_10_000_White = (Cases_White / Total_State_Population_White)*10000) %>%
mutate(Deaths_Per_10_000_African_American = (Deaths_African_American / Total_State_Population_African_American)*10000) %>% 
mutate(Deaths_Per_10_000_Asian = (Deaths_Asian / Total_State_Population_Asian)*10000) %>% 
mutate(Deaths_Per_10_000_Multi_Racial = (Deaths_Multi_Racial / Total_State_Population_Multi_Racial)*10000) %>%
mutate(Deaths_Per_10_000_Pacific_Islander = (Deaths_Pacific_Islander / Total_State_Population_Pacific_Islander)*10000) %>%
mutate(Deaths_Per_10_000_Hispanic = (Deaths_Hispanic / Total_State_Population_Hispanic)*10000) %>%
mutate(Deaths_Per_10_000_Native_American = (Deaths_Native_American / Total_State_Population_Native_American)*10000) %>%
mutate(Deaths_Per_10_000_White = (Deaths_White / Total_State_Population_White)*10000)

```


#Merges the Today's calculations with the master file
```{r}
today_race_calcs <- twodays3 %>% 
  filter(Date ==today)
#if you miss a day, fill this out and run instead
#filter(date == "2020-10-14")
  
  
#today_race_calcs <- janitor::clean_names(today_race_calcs)
glimpse(today_race_calcs)
```

#Writing the Final Updated File


```{r}
race4 <- smartbind(race3, today_race_calcs)
#Cut rows from df
#race4 <- slice(race4, -c(1))
#Cut Columns
#race4 <- race4[ -c(1) ]

race4 <- race4 %>% 
  arrange(desc(Date))

write.csv(race4, "race_main_file_11_2.csv")
```



#--------------------------------
#New Cases Today Table for Flourish
#--------------------------------
#Rename variables here

#weeklycases <- weeklycases %>%
#  rename(Weekly_Total_New_Cases = week_newcases, Week_Beginning = Date)



```{r}
write.csv(race4, "race_FLOURISH_main_file.csv")
```


```{r}
x <- race4 %>% 
  select(Date, New_Cases_African_American, New_Cases_Asian, New_Cases_Hispanic, New_Cases_Multi_Racial, New_Cases_Native_American, New_Cases_Other, New_Cases_Race_Or_Ethnicity_Unknown, New_Cases_White) %>% 
  filter(Date == today) %>% 
  distinct()

#flip
race_new_cases <- gather(x, key = "Race", value = "New_Cases", New_Cases_African_American, New_Cases_Asian, New_Cases_Hispanic, New_Cases_Multi_Racial, New_Cases_Native_American, New_Cases_Other, New_Cases_Race_Or_Ethnicity_Unknown, New_Cases_White)

race_new_cases
write.csv(race_new_cases, "race_new_cases.csv")
```

#New Deaths Today Table for Flourish
```{r}
race_new_deaths <- race4 %>% 
  select(Date, New_Deaths_African_American, New_Deaths_Asian, New_Deaths_Hispanic, New_Deaths_Multi_Racial, New_Deaths_Native_American, New_Deaths_Other, New_Deaths_Race_Or_Ethnicity_Unknown, New_Deaths_White) %>% 
  filter(Date == today) %>% 
  distinct()

#flip
race_new_deaths <- gather(race_new_deaths, key = "Race", value = "New_Deaths", New_Deaths_African_American, New_Deaths_Asian, New_Deaths_Hispanic, New_Deaths_Multi_Racial, New_Deaths_Native_American, New_Deaths_Other, New_Deaths_Race_Or_Ethnicity_Unknown, New_Deaths_White)

race_new_deaths
write.csv(race_new_deaths, "race_new_deaths.csv")
```
#COMBINE race_new_cases and race new deaths
```{r}
#SF$disposition1 <- str_replace_all(SF$disposition1, pattern=fixed('ABA'), replacement=fixed('Abated') )
#strip the race name down
race_new_cases$NEW <- str_replace_all(race_new_cases$Race, pattern=fixed('New_Cases_'), replacement=fixed(''))
race_new_deaths$NEW <- str_replace_all(race_new_deaths$Race, pattern=fixed('New_Deaths_'), replacement=fixed(''))

```

```{r}
race_new_cases_deaths <- race_new_cases %>% 
   inner_join(race_new_deaths, by=c("NEW", "Date"))

race_new_cases_deaths <- race_new_cases_deaths %>% 
  select(Date, NEW, New_Cases, New_Deaths)

colnames(race_new_cases_deaths)[2] <- "Race_Ethnicity"
head(race_new_cases_deaths)

write.csv(race_new_cases_deaths, "race_new_cases_deaths.csv")
```

#----------------------------------------------------------------------------------------------------#
#Gender
#----------------------------------------------------------------------------------------------------#
#Today's data 
```{r}
today_gender <- today_demo %>% 
  select(Date, Male, Female, Na)
```


```{r}
glimpse(today_demo)
```


#Rename

```{r}
today_gender2 <- today_gender

today_gender2 <- today_gender2 %>% 
  rename(Cases_Male = Male, Cases_Female = Female, Cases_Gender_Unknown = Na)

today_gender2$Date <- as.Date(today_gender2$Date)

#today_gender2 <- janitor::clean_names(today_gender2)

glimpse(today_gender2)
```

#Today_yesterday
#Import the master file for gender

```{r}
#gender_master <- rio::import("gender_master_10_11.csv")
gender_master <- rio::import("https://raw.githubusercontent.com/Arkansascovid/Main/master/gender_master.csv")

gender_master <- gender_master %>% 
  rename(Index = V1, Date = date, Cases_Male = cases_male, Cases_Female = cases_female, Cases_Gender_Unknown = cases_gender_unknown, New_Cases_Male = new_cases_male, New_Cases_Female = new_cases_female, New_Cases_Gender_Unknown = new_cases_gender_unknown)

names(gender_master)
```

```{r}
#gender_master <- janitor::clean_names(gender_master)

yesterday_gender <- gender_master %>% 
   filter(Date == yesterday)

yesterday_gender <- gender_master %>% 
  select(Date, Cases_Male, Cases_Female, Cases_Gender_Unknown)

glimpse(yesterday_gender)
```

#You should get a df with 2 observations (two days' worth a data)
```{r}
twodays3 <- smartbind(today_gender2, yesterday_gender)

# twodays3 <- twodays3 %>% 
#   distinct()
#cut an extra day off
#twodays3 <- slice(twodays3, -c(1))
glimpse(twodays3)

```

-**The Today-Yesterday Calculations**

```{r}
gender2 <- twodays3 %>%
mutate(New_Cases_Male = (Cases_Male -lead(Cases_Male))) %>% 
  mutate(New_Cases_Female = (Cases_Female-lead(Cases_Female))) %>% 
  mutate(New_Cases_Gender_Unknown = (Cases_Gender_Unknown-lead(Cases_Gender_Unknown)))

names(gender2)

write.csv(gender2, "gender_master_11_1.csv")
```

#New Cases Today Table for Flourish

```{r}
write.csv(gender2, "gender_FLOURISH_master.csv")
```

```{r}
gender_new_cases <- gender2 %>% 
  select(Date, "New_Cases_Male", "New_Cases_Female","New_Cases_Gender_Unknown") %>% 
  filter(Date == today)

#flip
gender_new_cases <- gather(gender_new_cases, key = "Gender", value = "New_Cases", "New_Cases_Male", "New_Cases_Female","New_Cases_Gender_Unknown")

gender_new_cases
write.csv(gender_new_cases, "gender_new_cases.csv")
```





#----------------------------------------------------------------------------------------------------#
#----------------------------------------------------------------------------------------------------#
# NOTES BELOW
#----------------------------------------------------------------------------------------------------#
#----------------------------------------------------------------------------------------------------#

#Build this 
#----------------------------------------------------------------------------------------------------#
#Facility
#----------------------------------------------------------------------------------------------------#

```{r}
(facility2, "facility_10_13.csv")
```

#----------------------------------------------------------------------------------------------------#
#----------------------------------------------------------------------------------------------------#

```{r}
glimpse(today_demo)
```

#Build this 



#MISC

```{r}
glimpse(today_demo)
today_demo_10_12 <- today_demo
write.csv(today_demo, "today_demo_10_12.csv")
```




#----------------------------------------------------------------------------------------------------#
#----------------------------------------------------------------------------------------------------#
# STOP!!!!!
#----------------------------------------------------------------------------------------------------#
#----------------------------------------------------------------------------------------------------#


#This section should be the only time we run this to break down the old spreadsheet format into machine-readable language
-**Import Demographic Data for Cleaning**
```{r}
demo_table <- rio::import("/Users/rswells/Dropbox/Classes/Data Fall 2020/ArkansasCovid/Marys_Demo_Table_10_11.csv")

demo_table$date <- lubridate::mdy(demo_table$date)
demo_table <- janitor::clean_names(demo_table)
glimpse(demo_table)
```

#age 
```{r}
age <- demo_table %>% 
  filter(detail == "Age")

age2 <- age %>% 
  select(date, sub_detail, cases, new_cases, deaths, new_deaths)

age3 <- age2 %>% 
  pivot_wider(names_from = sub_detail, values_from = c(cases, new_cases, deaths, new_deaths))
write.csv(age3, "age_10_13.csv")
```
#One Time Building of the Age table
```{r}
# colnames(age3)[29] <- "deaths_11_17"
# age3B <- age3 [ -c(1:2) ]
# names(age3B)
# 
# age3B <- age3B %>% 
#    select("date", "cases_0_10", "cases_11_17", "cases_18_24", "cases_25_34", "cases_35_44", "cases_45_54", "cases_55_64", "cases_65", "cases_unknown", "deaths_0_10", "deaths_11_17", "deaths_18_24", "deaths_25_34", "deaths_35_44", "deaths_45_54", "deaths_55_64", "deaths_65", "deaths_unknown", "cases_0_17", "cases_25_44", "cases_45_64", "deaths_0_17", "deaths_25_44", "deaths_45_64")
# names(age3B)
# 
# age3D <- age3B %>% 
#   mutate(new_cases_0_10 = (cases_0_10-lead(cases_0_10))) %>% 
#   mutate(new_cases_11_17 = (cases_11_17-lead(cases_11_17))) %>% 
#   mutate(new_cases_18_24 = (cases_18_24-lead(cases_18_24))) %>% 
#   mutate(new_cases_25_34 = (cases_25_34-lead(cases_25_34))) %>%  
#   mutate(new_cases_35_44 = (cases_35_44-lead(cases_35_44))) %>%  
#   mutate(new_cases_45_54 = (cases_45_54-lead(cases_45_54))) %>%
#   mutate(new_cases_55_64 = (cases_55_64-lead(cases_55_64))) %>%
#   mutate(new_cases_65 = (cases_65-lead(cases_65))) %>% 
#   mutate(new_deaths_0_10 = (deaths_0_10-lead(deaths_0_10))) %>% 
#   mutate(new_deaths_11_17 = (deaths_11_17-lead(deaths_11_17))) %>% 
#   mutate(new_deaths_18_24 = (deaths_18_24-lead(deaths_18_24))) %>% 
#   mutate(new_deaths_25_34 = (deaths_25_34-lead(deaths_25_34))) %>%  
#   mutate(new_deaths_35_44 = (deaths_35_44-lead(deaths_35_44))) %>%  
#   mutate(new_deaths_45_54 = (deaths_45_54-lead(deaths_45_54))) %>%
#   mutate(new_deaths_55_64 = (deaths_55_64-lead(deaths_55_64))) %>%
#   mutate(new_deaths_65 = (deaths_65-lead(deaths_65))) %>% 
#   mutate(new_cases_0_17 = (cases_0_17-lead(cases_0_17))) %>% 
#   mutate(new_cases_25_44 = (cases_25_44-lead(cases_25_44))) %>%
#   mutate(new_cases_45_64 = (cases_45_64-lead(cases_45_64))) %>%
#   mutate(new_deaths_0_17 = (deaths_0_17-lead(deaths_0_17))) %>%
#   mutate(new_deaths_25_44 = (deaths_25_44-lead(deaths_25_44))) %>%
#   mutate(new_deaths_45_64 = (deaths_45_64-lead(deaths_45_64)))
# write.csv(age3D, "age_update_10_12.csv")
```

#facility
```{r}
facility <- demo_table %>% 
  filter(detail == "Facility Type")

#clean
facility <- facility %>% 
  select(date, sub_detail, cases, new_cases, deaths, new_deaths)
glimpse(facility)

facility2 <- facility %>% 
  pivot_wider(names_from = sub_detail, values_from = c(cases, new_cases, deaths, new_deaths))

write_csv(facility2, "facility_10_13.csv")
```

#race
```{r}
race <- demo_table %>% 
  filter(detail == "Race or Ethnicity")
glimpse(race)
#clean

race2 <- race %>% 
  select(date, sub_detail, cases, new_cases, deaths, new_deaths, total_state_population, pct_state_population, cases_per_10_000, deaths_per_10_000)
glimpse(race2)

race3 <- race2 %>% 
  pivot_wider(names_from = sub_detail, values_from = c(cases, new_cases, deaths, new_deaths, total_state_population, pct_state_population, cases_per_10_000, deaths_per_10_000))

glimpse(race3)

write.csv(race3, "race_10_13.csv")

```

```{r}
glimpse(gender_master)
```

#gender create the table
```{r}
gender <- demo_table %>% 
  filter(detail == "Gender")

gender2 <- gender %>% 
  select(date, sub_detail, cases, new_cases)
glimpse(gender2)

write.csv(gender2, "gender_10_13.csv")
#clean

gender_master2 <- gender_master %>% 
  select(date, sub_detail, cases, new_cases)

gender_master2 <- gender_master2 %>% 
  pivot_wider(names_from = sub_detail, values_from = c(cases, new_cases))

write.csv(gender_master2, "gender_master_10_11.csv")
```

#----------------------------------------------------------------------------------------------------#
#----------------------------------------------------------------------------------------------------#
# END OF ONE TIME SECTION
#----------------------------------------------------------------------------------------------------#
#----------------------------------------------------------------------------------------------------#




-**30**


