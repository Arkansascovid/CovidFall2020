---
title: "Daily Update Arkansas Covid"
author: "Rob Wells"
date: "9/11/2020"
output: pdf_document
---

# State Data Daily Update Arkansascovid.com Calculations

- **This notebook retrieves data from a Google sheet, performs all of the county calculations and rejoins it with the main DateMaster sheet.**

-**It creates a masterfile: all_state_and_hospitals.csv**

# Part 1: Import State Data, Clean It

```{r include=FALSE}
library(tidyverse)
library(janitor)
library(lubridate)
library(googlesheets4)
library(googledrive)
library(tidyr)
library(jsonlite)
library(gtools)
#install.packages("gtools")
# vignette("basic-usage", package="googlesheets")
#install.packages("googledrive")
#install.packages("googlesheets4")
```

## Retrieve State Arkansas Covid Data from ADH FEED
```{r}
#New County json feed
#38 Variables
q <- fromJSON('https://services.arcgis.com/PwY9ZuZRDiI5nXUB/ArcGIS/rest/services/UPDATED_ADH_COVID19_COUNTY_METRICS/FeatureServer/0/query?where=0%3D0&objectIds=&time=&geometry=&geometryType=esriGeometryEnvelope&inSR=&spatialRel=esriSpatialRelIntersects&resultType=none&distance=0.0&units=esriSRUnit_Meter&returnGeodetic=false&outFields=*&returnGeometry=true&returnCentroid=false&featureEncoding=esriDefault&multipatchOption=xyFootprint&maxAllowableOffset=&geometryPrecision=&outSR=&datumTransformation=&applyVCSProjection=false&returnIdsOnly=false&returnUniqueIdsOnly=false&returnCountOnly=false&returnExtentOnly=false&returnQueryGeometry=false&returnDistinctValues=false&cacheHint=false&orderByFields=&groupByFieldsForStatistics=&outStatistics=&having=&resultOffset=&resultRecordCount=&returnZ=false&returnM=false&returnExceededLimitFeatures=true&quantizationParameters=&sqlFormat=none&f=pjson&token=')

df3 <- q[["features"]][["attributes"]]
#print's today's date as a date field
df3$mydate <- Sys.Date()
#file.exists(filename)
#austin help on that
#if file exists = check if current data is different and if that is true then append today's data set to master dataset and resave
today_county <- df3
```


```{r}
today_county <- janitor::clean_names(today_county)
```


#Set Dates
```{r}
#today's date
today <- Sys.Date()
#NOTE: IF YOU ARE RUNNING THIS A DAY LATE, USE THIS CODE TO WORK PROPERLY
#today <- Sys.Date()-1

#yesterday's date
yesterday <- (today-1)

```

#Quick Calculation of State Totals for Our Own Tweet
```{r}
today_county <- today_county [ -c(1) ]
today_county [2:37] <- lapply(today_county [2:37], as.numeric)
#Calculate statewide totals

today_county <- today_county %>%
  janitor::adorn_totals("row") %>% 
  mutate(mydate=(today))

today_county$county_nam <- str_replace_all(today_county$county_nam, pattern=fixed('Total'), replacement=fixed('Arkansas_all_counties') )
today_county$county_nam  <- gsub("[[:space:]]", "", today_county$county_nam)
today_county$mydate <- as.Date(today_county$mydate)
```

-**Import and Clean Yesterday's Data**
```{r}
yesterday_county <- rio::import("master_file.csv")
#yesterday_county <- yesterday_county [ -c(1) ]
yesterday_county$mydate <- as.Date(yesterday_county$mydate)
#ran this to test it out on today's data
#x <- yesterday_county %>% 
#  filter(mydate==(yesterday))
yesterday_county[4:45] <- lapply(yesterday_county[4:45], as.numeric)
```
# .
# COUNTY DATA SECTION 
#  .
- **This section performs all of the county calculations .**
--**It creates XXXX **

- **Previous Date Calculations**

Create Temporary Table Two Days' Worth of Data
Sort Alphbetically and Run Calculations

```{r}
countytemp <- yesterday_county %>% 
  filter(mydate>=(yesterday)) %>%  
  arrange(county_nam) 
```

You should get a df with 154 observations (two days' worth a data)
```{r}
df_master <- smartbind(today_county, countytemp)

twodays <- df_master %>% 
  arrange((county_nam))
```


-**The Today-Yesterday Calculations**

```{r}
twodays <- twodays %>%
  mutate(Number_Tested=(positive+negative)) %>% 
  mutate(New_Cases_Today = (positive-lead(positive))) %>%
  mutate(Recovered_Since_Yesterday = (recoveries-lead(recoveries))) %>%
  mutate(New_Deaths_Today = (deaths-lead(deaths))) %>%
  mutate(New_Tests_Dashboard = (Number_Tested-lead(Number_Tested)))
```

- **IMPORTANT: FILTER TABLE TO TODAY'S RESULTS**
```{r}
twodays <- twodays %>% filter(mydate > yesterday) #SHOULD GET 77 ROWS IN twodays
```


```{r}
glimpse(twodays)
```

-**The Percentage Calculations**

```{r}
twodays <- twodays %>%
  mutate(Cases_Population = (positive / pop_5yr_est_2018)*100) %>% 
  mutate(Tested_Population = (Number_Tested / pop_5yr_est_2018)*100) %>% 
  mutate(New_Cases_Today_10k_Pop = (New_Cases_Today/pop_5yr_est_2018)*10000) %>% 
  mutate(Active_Cases_10k_Pop = (confirmed_active/pop_5yr_est_2018)*10000) %>% 
  mutate(Pct_Positive_Cumulative = (positive/Number_Tested)*100) %>% 
  mutate(Pct_Positive_New_to_Dashboard = (New_Cases_Today/New_Tests_Dashboard)*100) %>% 
  mutate(Closed = (recoveries + deaths)) %>% 
  mutate(Pct_Deaths_vs_Recoveries = (deaths/Closed)*100) %>% 
  mutate(Pct_Recoveries_vs_Deaths = (recoveries/Closed)*100)
  
twodays
```

#Merges the Today's Arkanas_All_Counties line with yesterday's data. 
```{r}
master2 <- smartbind(twodays, yesterday_county, fill=0)
```
```{r}

master2 <- master2 %>% 
  select("county_nam","mydate","deaths","fhwa_numbe","fips","positive","negative","recoveries","total_tests","active_cases","pop_5yr_est_2018","confirmed_pos","probable_pos","confirmed_neg","probable_neg","confirmed_recov","probable_recov","confirmed_death","probable_death", "confirmed_active","probable_active","pcr_test","antigen_test","pcr_pos_test", "pcr_neg_test","antigen_pos_test","antigen_neg_test","total_pos_test","total_neg_test",
"New_Cases_Today","Recovered_Since_Yesterday","New_Deaths_Today","New_Tests_Dashboard","Cases_Population","Tested_Population","New_Cases_Today_10k_Pop","Active_Cases_10k_Pop","Pct_Positive_Cumulative","Pct_Positive_New_to_Dashboard","Closed","Pct_Deaths_vs_Recoveries","Pct_Recoveries_vs_Deaths","lab_prvt","lab_pub")
master2$mydate <- as.Date(master2$mydate)
glimpse(master2)
```

#Save master file
```{r}
#write.csv(master2, "master_file_9_18.csv")
write.csv(master2, "master_file.csv")
```

#Quick Update File for Twitter
#Latest Tweet Slide Data
```{r}
top_numbers <- master2 %>% 
  filter(county_nam=="Arkansas_all_counties") %>% 
    filter(mydate>=(yesterday)) %>% 
  select(county_nam, mydate, New_Cases_Today, positive, confirmed_pos, recoveries, deaths, confirmed_death, New_Deaths_Today, active_cases, confirmed_active,  Recovered_Since_Yesterday)
write.csv(top_numbers, "top numbers.csv")
```
#.
#.
# Hospital Data
#.
#.
# IMPORT THE DAILY TWEET HOSPITAL DATA FROM THE GOOGLE Form

```{r include=FALSE}
url2 <- ("https://docs.google.com/spreadsheets/d/1ikblX8tikM59ma1AftkqgGbyeZkXB6DuBtwMsVeoGYw/edit?usp=sharing")

hospital <- read_sheet(url2, sheet = "Hospital-TWEET SLIDE",  col_types = NULL, na = "",trim_ws = TRUE)
#clean names
hospital <- janitor::clean_names(hospital)
hospital <- hospital %>% 
  arrange(desc(date))
hospital <- hospital [ -c(1) ]
colnames(hospital)[2:5] <- c("Hospitalized", "Vent", "Ever_Hospitalized", "Ever_on_a_Vent")
hospital[2:5] <- lapply((hospital)[2:5], as.numeric)
hospital$date <- as.Date(hospital$date)
```

```{r}
glimpse(hospital)
```


```{r}
main_hospital <- master2 %>% 
  filter(county_nam=="Arkansas_all_counties") %>% 
  select(mydate, confirmed_active, active_cases) %>%
 
main_hospital2 <- left_join(hospital, main_hospital, by=c("date"="mydate"))
glimpse(main_hospital2)
```

#Hospital Math

```{r}
hospital1 <- main_hospital2 %>% 
  mutate(New_Admits = (Ever_Hospitalized-lead(Ever_Hospitalized))) %>% 
  mutate(Hosp_Change_from_Yesterday = (Hospitalized-lead(Hospitalized))) %>% 
  mutate(New_Discharges_Deaths = (New_Admits-Hosp_Change_from_Yesterday)) %>% 
  mutate(Pct_Vent = (Vent/Hospitalized)*100) %>% 
  mutate(New_on_Vent = (Ever_on_a_Vent-lead(Ever_on_a_Vent,na.rm=TRUE)))%>% 
  mutate(Pct_Hospitalized = (Hospitalized/active_cases)*100)

hospital1 <- hospital1 %>% 
  filter(date ==(today))

hospital1
```

```{r}
#Joint today's with hospital master.csv
hospital_master <- rio::import("https://raw.githubusercontent.com/Arkansascovid/Main/master/hospital_master.csv")
hospital_master <- hospital_master [ -c(1) ]
hospital_master[2:13] <- lapply((hospital_master)[2:13], as.numeric)
hospital_master$date <- as.Date(hospital_master$date)
glimpse(hospital_master)
```


```{r}
#make hospital_master.csv

hospital_master <- rbind(hospital1, hospital_master)
write.csv(hospital_master, "hospital_master.csv")
```


# IMPORT THE DAILY EMAILED HOSPITAL DATA FROM THE GOOGLE Form

```{r include=FALSE}
url3 <- ("https://docs.google.com/spreadsheets/d/1ikblX8tikM59ma1AftkqgGbyeZkXB6DuBtwMsVeoGYw/edit?usp=sharing")

hospitalemail <- read_sheet(url2, sheet = "Hospital_email",  col_types = NULL, na = "",trim_ws = TRUE)
#clean names
hospitalemail <- janitor::clean_names(hospitalemail)
hospitalemail  <- hospitalemail  %>% 
  arrange(desc(date))
hospitalemail  <- hospitalemail  [ -c(1) ]
glimpse(hospitalemail)
colnames(hospitalemail)[1:10] <- c("Date", "Hospitalized", "Total_Beds", "Total_Beds_Available", "Total_ICU_Beds", "Total_ICU_Beds_Available", "Total_Vents", "Total_Vents_Available","Total_Covid_In_ICU","Total_Covid_Patients_Vent")
hospitalemail$Date <- as.Date(hospitalemail$Date)
```


```{r}
write.csv(hospitalemail, "hospital_email_data.csv")
head(hospitalemail)
```



-**30**