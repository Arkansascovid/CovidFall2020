---
title: "Daily Update Arkansas Covid"
author: "Rob Wells & Katy Seiter"
date: "12/18/2020"
output: pdf_document
---

# State Data Daily Update Arkansascovid.com Calculations

- **This notebook retrieves data from a Google sheet, performs all of the county calculations and rejoins it with the main DateMaster sheet.**

-**It creates a masterfile: all_state_and_hospitals.csv**

# Part 1: Import State Data, Clean It

```{r include=FALSE}
#install.packages("slider")
#install.packages("zoo")
#install.packages("gtools")
# vignette("basic-usage", package="googlesheets")
#install.packages("googledrive")
#install.packages("googlesheets4")
#install.packages("kableExtra")
library(tidyverse)
library(janitor)
library(lubridate)
library(googlesheets4)
library(googledrive)
library(tidyr)
library(jsonlite)
library(gtools)
library(zoo)  
library(reshape2)
library(slider)

```

## Retrieve State Arkansas Covid Data from ADH FEED
```{r}
#New County json feed
#38 Variables
q <- fromJSON('https://services.arcgis.com/PwY9ZuZRDiI5nXUB/ArcGIS/rest/services/UPDATED_ADH_COVID19_COUNTY_METRICS/FeatureServer/0/query?where=0%3D0&objectIds=&time=&geometry=&geometryType=esriGeometryEnvelope&inSR=&spatialRel=esriSpatialRelIntersects&resultType=none&distance=0.0&units=esriSRUnit_Meter&returnGeodetic=false&outFields=*&returnGeometry=true&returnCentroid=false&featureEncoding=esriDefault&multipatchOption=xyFootprint&maxAllowableOffset=&geometryPrecision=&outSR=&datumTransformation=&applyVCSProjection=false&returnIdsOnly=false&returnUniqueIdsOnly=false&returnCountOnly=false&returnExtentOnly=false&returnQueryGeometry=false&returnDistinctValues=false&cacheHint=false&orderByFields=&groupByFieldsForStatistics=&outStatistics=&having=&resultOffset=&resultRecordCount=&returnZ=false&returnM=false&returnExceededLimitFeatures=true&quantizationParameters=&sqlFormat=none&f=pjson&token=')

df3 <- q[["features"]][["attributes"]]
#print's today's date as a date field
df3$mydate <- Sys.Date()
#file.exists(filename)
#austin help on that
#if file exists = check if current data is different and if that is true then append today's data set to master dataset and resave
today_county <- df3
```

```{r}
#If this fails, check the backup from Austin
#https://docs.google.com/spreadsheets/d/1WRITgZZdI5PwiJiJeutBjJigSifOaNPDyTW_jHizfGQ/edit?usp=sharing
```



```{r}
today_county <- janitor::clean_names(today_county)
```


#Set Dates
```{r}
#today's date
today <- Sys.Date()

#NOTE: IF YOU ARE RUNNING THIS A DAY LATE, USE THIS CODE TO WORK PROPERLY
#today <- Sys.Date()-1
#today_county$mydate <-"2020-09-22- THE OLD DATE...."

#yesterday's date
yesterday <- (today-1)

```

#Quick Calculation of State Totals 
```{r}
today_county <- today_county [ -c(1) ]
today_county [2:37] <- lapply(today_county [2:37], as.numeric)
#Calculate statewide totals

today_county <- today_county %>%
  janitor::adorn_totals("row") %>% 
  mutate(mydate=(today))

today_county$county_nam <- str_replace_all(today_county$county_nam, pattern=fixed('Arkansas'), replacement=fixed('Arkansas_county') )
today_county$county_nam <- str_replace_all(today_county$county_nam, pattern=fixed('Total'), replacement=fixed('Arkansas_all_counties') )
today_county$county_nam  <- gsub("[[:space:]]", "", today_county$county_nam)
today_county$mydate <- as.Date(today_county$mydate)
```

-**Import and Clean Yesterday's Data**
```{r}
yesterday_county <- rio::import("https://raw.githubusercontent.com/Arkansascovid/Main/master/master_file.csv")
#yesterday_county <- yesterday_county [ -c(1) ]
yesterday_county$mydate <- as.Date(yesterday_county$mydate)
#ran this to test it out on today's data
 # yesterday_county <- yesterday_county %>% 
 #  filter(mydate<=(yesterday))
yesterday_county[4:45] <- lapply(yesterday_county[4:45], as.numeric)
```
# .
# Previous Date Calculations
#  .
-**This section performs all of the county calculations**   
-**It updates master_file.csv**  
-**Create Temporary Table Two Days' Worth of Data**   
-**Sort Alphbetically and Run Calculations**   

```{r}
countytemp <- yesterday_county %>% 
  filter(mydate>=(yesterday)) %>%  
  arrange(county_nam) 
```

You should get a df with 154 observations (two days' worth a data)
```{r}
df_master <- smartbind(today_county, countytemp)

twodays <- df_master %>% 
  arrange((county_nam))
```


-**The Today-Yesterday Calculations**

```{r}
twodays <- twodays %>%
  mutate(Number_Tested=(positive+negative)) %>% 
  mutate(New_Cases_Today = (positive-lead(positive))) %>%
  mutate(Recovered_Since_Yesterday = (recoveries-lead(recoveries))) %>%
  mutate(New_Deaths_Today = (deaths-lead(deaths))) %>%
  mutate(New_Tests_Dashboard = (Number_Tested-lead(Number_Tested)))
```

- **IMPORTANT: FILTER TABLE TO TODAY'S RESULTS**
```{r}
twodays <- twodays %>% filter(mydate > yesterday) #SHOULD GET 77 ROWS IN twodays
```


```{r}
glimpse(twodays)
```

-**The Percentage Calculations**

```{r}
twodays <- twodays %>%
  mutate(Cases_Population = (positive / pop_5yr_est_2018)*100) %>% 
  mutate(Tested_Population = (Number_Tested / pop_5yr_est_2018)*100) %>% 
  mutate(New_Cases_Today_10k_Pop = (New_Cases_Today/pop_5yr_est_2018)*10000) %>% 
  mutate(Active_Cases_10k_Pop = (confirmed_active/pop_5yr_est_2018)*10000) %>% 
  mutate(Pct_Positive_Cumulative = (positive/Number_Tested)*100) %>% 
  mutate(Pct_Positive_New_to_Dashboard = (New_Cases_Today/New_Tests_Dashboard)*100) %>% 
  mutate(Closed = (recoveries + deaths)) %>% 
  mutate(Pct_Deaths_vs_Recoveries = (deaths/Closed)*100) %>% 
  mutate(Pct_Recoveries_vs_Deaths = (recoveries/Closed)*100)
  
twodays
```

#Merges the Today's Arkanas_All_Counties line with yesterday's data. 
```{r}
master2 <- smartbind(twodays, yesterday_county, fill=0)
```

```{r}

master2 <- master2 %>% 
  select("county_nam","mydate","deaths","fhwa_numbe","fips","positive","negative","recoveries","total_tests","active_cases","pop_5yr_est_2018","confirmed_pos","probable_pos","confirmed_neg","probable_neg","confirmed_recov","probable_recov","confirmed_death","probable_death", "confirmed_active","probable_active","pcr_test","antigen_test","pcr_pos_test", "pcr_neg_test","antigen_pos_test","antigen_neg_test","total_pos_test","total_neg_test",
"New_Cases_Today","Recovered_Since_Yesterday","New_Deaths_Today","New_Tests_Dashboard","Cases_Population","Tested_Population","New_Cases_Today_10k_Pop","Active_Cases_10k_Pop","Pct_Positive_Cumulative","Pct_Positive_New_to_Dashboard","Closed","Pct_Deaths_vs_Recoveries","Pct_Recoveries_vs_Deaths","lab_prvt","lab_pub")
master2$mydate <- as.Date(master2$mydate)
glimpse(master2)
```





#Save master file
```{r}
#write.csv(master2, "master_file_9_18.csv")
write.csv(master2, file = "MasterData/master_file.csv")

```

#Top Numbers Table 
```{r}
top_numbers <- master2 %>% 
  filter(county_nam=="Arkansas_all_counties") %>% 
    filter(mydate>=(yesterday)) %>% 
  select(mydate, New_Cases_Today, positive, confirmed_pos, deaths, New_Deaths_Today,confirmed_death, active_cases, confirmed_active, recoveries, Recovered_Since_Yesterday)

top_numbers <- top_numbers %>% 
  rename(Date = mydate, Positive_Cases = positive, Confirmed_Positives = confirmed_pos, Recoveries = recoveries, Deaths = deaths, Confirmed_Deaths = confirmed_death, Active_Cases = active_cases, Confirmed_Active_Cases = confirmed_active)

t <- t(top_numbers)

t <- data.frame(Value = row.names(t), t)
colnames(t)[2:3] <- c("Today", "Yesterday")
row.names(t) <- NULL

library(kableExtra)
t %>% 
  kable() %>%
  kable_styling("striped") 
```

# AVERAGE CALCULATIONS 
```{r}
test <- master2 %>% 
  group_by(county_nam) %>%
  arrange(county_nam, mydate) %>%
  mutate(Positive_7_Day_Avg = slider::slide_dbl(positive, mean, .before = 6, .after = 0)) %>%
  mutate(New_Cases_7_Day_Avg = slider::slide_dbl(New_Cases_Today, mean, .before = 6, .after = 0)) %>%
  mutate(New_Deaths_7_Day_Avg = slider::slide_dbl(New_Deaths_Today, mean, .before = 6, .after = 0)) %>%
ungroup()

#Run this before writing script to get back in descending order by date

test <- test %>% 
  arrange(desc(mydate))

test2 <- test %>% 
  select(mydate, county_nam, positive, Positive_7_Day_Avg, New_Cases_Today, New_Cases_7_Day_Avg, New_Deaths_Today, New_Deaths_7_Day_Avg, Recovered_Since_Yesterday, active_cases) %>% 
  filter(county_nam=="Arkansas_all_counties") %>% 
  filter(mydate>=(yesterday))

#Alex Nichol decimal rounding:
test2$Positive_7_Day_Avg <-round(test2$Positive_7_Day_Avg, 1)
test2$New_Cases_7_Day_Avg <-round(test2$New_Cases_7_Day_Avg, 1)
test2$New_Deaths_7_Day_Avg <-round(test2$New_Deaths_7_Day_Avg, 1)

write.csv(test2, "test2.csv")
```


# CREATE NEW CASES AND RECOVERIES SLIDE - 2 DAYS
```{r}

df4 <- melt(test2[,c("mydate", "New_Cases_Today","New_Cases_7_Day_Avg", "Recovered_Since_Yesterday")], id.vars = 1)

df4 <- df4 %>% 
  rename(Detail = variable, Amount = value)

ggplot(df4,aes(x = mydate, y = Amount, label = Amount, fill= Detail)) + 
geom_bar(stat="identity", position="dodge", color="white")+
scale_fill_manual(values=c("#B3BF08", "#08B3BF", "#D68037"))+
scale_y_continuous(limits=c(0, 3000))  +
  theme_bw() + 
  theme(
    plot.title = element_text(face = "bold", size = 16),
    legend.background = element_rect(fill = "white", size = .01, colour = "white"),
    legend.justification = c(0, 1),
    #adjust the box position. First number horizontal, second, vertical 
    legend.position = c(.617, .38),
    #legend.position = c(.1, .38),
    axis.ticks = element_line(colour = "grey70", size = 0.2),
    panel.grid.major = element_line(colour = "grey70", size = 0.2),
    panel.grid.minor = element_blank()
  )+
   geom_col(position = position_dodge2(width = 0.9, preserve = "single")) +
  geom_text(position = position_dodge2(width = 0.9, preserve = "single"), vjust=-0.5, hjust=+0.5) +
  labs(title = "New Cases & Recoveries in Arkansas Announced Today", 
       subtitle = "Confirmed + Probable,  ADH Data for Dec. 12, 2020",
       caption = "Graphic by ArkansasCovid.com",
       y="Amount",
       x="Date")
ggsave("Changes_2_Day_avg.png",device = "png",width=9,height=6, dpi=400)
```



# CREATE DEATHS SLIDE - 2 DAYS
```{r}
df5 <- melt(test2[,c("mydate", "New_Deaths_Today","New_Deaths_7_Day_Avg")], id.vars = 1)

df5 <- df5 %>% 
  rename(Detail = variable, Amount = value)

#deaths 2-day snapshot
ggplot(df5,aes(x = mydate, y = Amount, label = Amount, fill= Detail)) + 
geom_bar(stat="identity", position="dodge", color="white")+
scale_fill_manual(values=c("#08B3BF", "#D68037"))+
  theme(legend.position = "bottom") +
  geom_col(position = position_dodge2(width = 0.9, preserve = "single"), show.legend = T) +
  geom_text(position = position_dodge2(width = 0.9, preserve = "single"), vjust=-0.5, hjust=+0.5) +
  scale_y_continuous(limits=c(0, 60)) + 
  labs(title = "New Deaths in Arkansas Announced Today", 
       subtitle = "Confirmed + Probable,  ADH Data for Dec. 12, 2020",
       caption = "Graphic by ArkansasCovid.com",
       y="Amount",
       x="Date")
ggsave("Deaths_2_Day_avg.png",device = "png",width=9,height=6, dpi=400)

```



```{r}
# homepage <- master2 %>% 
#  filter(county_nam=="Arkansas_all_counties") %>% 
#   filter(mydate==today)
# write.csv(homepage, "homepage.csv")
```



```{r}
countytoday <- master2 %>% 
  filter(mydate==today)
write.csv(countytoday, "countytoday.csv")
```


```{r}
countyonlytoday <- master2 %>% 
  filter(mydate==today) %>% 
  filter(county_nam!="Arkansas_all_counties")
write.csv(countyonlytoday, "countyonlytoday.csv")
```
#.
#.
# Hospital Data
#.
#.
# IMPORT THE DAILY TWEET HOSPITAL DATA FROM THE GOOGLE Form
#for download
```{r}
# hospital <- rio::import("/Users/rswells/Dropbox/Classes/Data Fall 2020/ArkansasCovid/Hospital Data - Manual Input.xlsx", which = "Hospital-TWEET SLIDE")
```

#For Googlesheet access
```{r include=FALSE}
url2 <- ("https://docs.google.com/spreadsheets/d/1ikblX8tikM59ma1AftkqgGbyeZkXB6DuBtwMsVeoGYw/edit?usp=sharing")

hospital <- read_sheet(url2, sheet = "Hospital-TWEET SLIDE",  col_types = NULL, na = "",trim_ws = TRUE)
```


#clean names
```{r include=FALSE}
hospital <- janitor::clean_names(hospital)
hospital <- hospital %>% 
  arrange(desc(date))
hospital <- hospital [ -c(1) ]
colnames(hospital)[2:5] <- c("Hospitalized", "Vent", "Ever_Hospitalized", "Ever_on_a_Vent")
hospital[2:5] <- lapply((hospital)[2:5], as.numeric)
hospital$date <- as.Date(hospital$date)
```

```{r}
glimpse(hospital)
```

```{r}
#if restart and need to reimport
#master2 <- rio::import("master_file.csv")
#master2$mydate <- as.Date(master2$mydate)
```

```{r}
main_hospital <- master2 %>% 
  filter(county_nam=="Arkansas_all_counties") %>% 
  select(mydate, confirmed_active, active_cases) 
 
main_hospital2 <- left_join(hospital, main_hospital, by=c("date"="mydate"))
glimpse(main_hospital2)
```

#Hospital Math

```{r}
hospital1 <- main_hospital2 %>% 
  mutate(New_Admits = (Ever_Hospitalized-lead(Ever_Hospitalized))) %>% 
  mutate(Hosp_Change_from_Yesterday = (Hospitalized-lead(Hospitalized))) %>% 
  mutate(New_Discharges_Deaths = (New_Admits-Hosp_Change_from_Yesterday)) %>% 
  mutate(Pct_Vent = (Vent/Hospitalized)*100) %>% 
  mutate(New_on_Vent = (Ever_on_a_Vent-lead(Ever_on_a_Vent,na.rm=TRUE)))%>% 
  mutate(Pct_Hospitalized = (Hospitalized/active_cases)*100)

# hospital1 <- hospital1 %>%
#   filter(date ==(today))

# hospital1 <- hospital1 %>%
#   filter(date >=("2020-11-19"))

 hospital1 <- hospital1 %>% 
   filter(date >(yesterday))
#Cut rows from df
#hospital1 <- slice(hospital1, -c(8))


hospital1
```

```{r}
#Join today's with hospital master.csv
hospital_master <- rio::import("https://raw.githubusercontent.com/Arkansascovid/Main/master/hospital_master.csv")
hospital_master <- hospital_master [ -c(1) ]
hospital_master$date <- lubridate::ymd(hospital_master$date)
hospital_master[2:13] <- lapply((hospital_master)[2:13], as.numeric)

glimpse(hospital_master)
```

```{r}
glimpse(hospital1)
```
```{r}
glimpse(hospital_master)
```

```{r}
#make hospital_master.csv

hospital_master <- rbind(hospital1, hospital_master)

 hospital_master <- hospital_master %>% 
   arrange(desc(date)) %>% 
   distinct()

#edit out rows if needed
#hospital_master <- slice(hospital_master, -c(3,4))


head(hospital_master)
write.csv(hospital_master, file = "MasterData/hospital_master.csv")
```

```{r}
#Flourish - May 1, 2020 filter
hospital_FLOURISH <- hospital_master %>%
  filter(date >= "2020-05-01")
#hospital_FLOURISH <- hospital_FLOURISH[ -c(1) ]
write.csv(hospital_FLOURISH, file = "HomePageData/hospital_FLOURISH.csv")
```

#hospital daily tweet slide
```{r}
#cute extra column from hospital_master
#hospital_master <- hospital_master[ -c(1) ]

hospital2 <- hospital_master %>% 
    filter(date>=(yesterday)) %>% 
  select(date, Hospitalized, Vent, New_Admits, New_on_Vent, New_Discharges_Deaths, Ever_Hospitalized, Ever_on_a_Vent)

hospital2 <- hospital2 %>% 
  rename(Date = date, On_Vents = Vent, Ever_on_Vent = Ever_on_a_Vent)

h <- t(hospital2)

h <- data.frame(Value = row.names(h), h)
colnames(h)[1:3] <- c("Value","Today", "Yesterday")
row.names(h) <- NULL


library(kableExtra)
h %>% 
  kable() %>%
  kable_styling("striped")
```


# IMPORT THE DAILY EMAILED HOSPITAL DATA FROM THE GOOGLE Form

```{r include=FALSE}
url3 <- ("https://docs.google.com/spreadsheets/d/1ikblX8tikM59ma1AftkqgGbyeZkXB6DuBtwMsVeoGYw/edit?usp=sharing")

hospitalemail <- read_sheet(url3, sheet = "Hospital_email",  col_types = NULL, na = "",trim_ws = TRUE)
```

```{r}
# hospitalemail <- rio::import("/Users/rswells/Dropbox/Classes/Data Fall 2020/ArkansasCovid/Hospital Data - Manual Input.xlsx", which = "Hospital_email")
```

```{r}
#clean names
hospitalemail <- janitor::clean_names(hospitalemail)
hospitalemail  <- hospitalemail  %>% 
  arrange(desc(date))
hospitalemail  <- hospitalemail  [ -c(1) ]
glimpse(hospitalemail)
colnames(hospitalemail)[1:10] <- c("Date", "Hospitalized", "Total_Beds", "Total_Beds_Available", "Total_ICU_Beds", "Total_ICU_Beds_Available", "Total_Vents", "Total_Vents_Available","Total_Covid_In_ICU","Total_Covid_Patients_Vent")
hospitalemail$Date <- as.Date(hospitalemail$Date)
```


```{r}
write.csv(hospitalemail, file = "MasterData/hospital_email_data.csv")
head(hospitalemail)
```



-**30**
