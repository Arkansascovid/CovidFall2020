---
title: "Flourish Sheets- County Changes Today, Statewide, and Deaths Stories"
author: "Katy Seiter and Rob Wells"
date: "11/02/2020"
output: html_document
---

```{r}
library(rio)
library(tidyverse)
library(slider)
library(lubridate)
library(formattable)
```

```{r}
master2 <- rio::import("master_file.csv")
#master2 <- rio::import("https://raw.githubusercontent.com/Arkansascovid/Main/master/master_file.csv")

```

#Rename columns
```{r}
master <- master2 %>%
  rename(County_Name = county_nam, Date = mydate, Deaths = deaths, Positive = positive, Negative = negative, Recoveries = recoveries, Total_Tests = total_tests, Active_Cases = active_cases, Confirmed_Positive = confirmed_pos, Probable_Positive =probable_pos, Confirmed_Negative = confirmed_neg, Probable_Negative = probable_neg, Confirmed_Recoveries = confirmed_recov, Probable_Recoveries = probable_recov, PCR_Positive_Test = pcr_pos_test, PCR_Negative_Tests = pcr_neg_test, Total_Positive_Test = total_pos_test, Total_Negative_Test = total_neg_test)

names(master)
```

#Homepage Numbers
```{r}
library(formattable)
homepage <- master %>% 
  select(County_Name, Date, New_Cases_Today, New_Deaths_Today, Deaths, Active_Cases) %>% 
 filter(County_Name=="Arkansas_all_counties") %>% 
  filter(Date==today)

# homepage$New_Cases_Today <- accounting(homepage$New_Cases_Today, digits = 0)
# homepage$New_Deaths_Today <- accounting(homepage$New_Deaths_Today, digits = 0)
# homepage$Deaths <- accounting(homepage$Deaths, digits = 0)
# homepage$Active_Cases <- accounting(homepage$Active_Cases, digits = 0)

write.csv(homepage, "homepage.csv")
```

#County snapshots
```{r}
countysnapshot <- master %>% 
   filter(Date>"2020-08-31")
write.csv(countysnapshot, "countysnapshot.csv")
```

#Only counties, one day calculations - County Changes Story: Active and New cases map, Deaths today by county, Top counties with new cases, Total tests by county, Cases and tests from dashboard, New Cases per 10k pop Slides; - Deaths Story: Total deaths by County Slide
```{r}
countyonlytoday <- master %>% 
  filter(Date==today) %>% 
  filter(County_Name!="Arkansas_all_counties") %>% 
  filter(County_Name!="MissingCountyInfo")

#CHECK CHECK - YOU MAY NEED TO SLICE OFF THE FIRST COLUMN
#countyonlytoday <- countyonlytoday [ -c(1) ]

countyonlytoday$County_Name <- str_replace_all(countyonlytoday$County_Name, pattern=fixed('Arkansas_county'), replacement=fixed('Arkansas') )
countyonlytoday$County_Name <- str_replace_all(countyonlytoday$County_Name, pattern=fixed('LittleRiver'), replacement=fixed('Little River') )
countyonlytoday$County_Name <- str_replace_all(countyonlytoday$County_Name, pattern=fixed('HotSpring'), replacement=fixed('Hot Spring') )
countyonlytoday$County_Name <- str_replace_all(countyonlytoday$County_Name, pattern=fixed('VanBuren'), replacement=fixed('Van Buren') )
countyonlytoday$County_Name <- str_replace_all(countyonlytoday$County_Name, pattern=fixed('St.Francis'), replacement=fixed('St. Francis') )

write.csv(countyonlytoday, "countyonlytoday.csv")
```


#Top counties with new cases and per 10K
```{r}
Top_counties_new_cases <-countyonlytoday %>% 
  top_n(10, New_Cases_Today) %>% 
  select(County_Name, New_Cases_Today, New_Cases_Today_10k_Pop) %>% 
  arrange(desc(New_Cases_Today))
write.csv(Top_counties_new_cases, "Top_counties_new_cases.csv")

Top_new_cases_10k_pop <-countyonlytoday %>% 
  top_n(10, New_Cases_Today_10k_Pop) %>% 
  select(County_Name, New_Cases_Today, New_Cases_Today_10k_Pop) %>% 
  arrange(desc(New_Cases_Today_10k_Pop))
write.csv(Top_new_cases_10k_pop, "Top_new_cases_10k_pop.csv")

```

#Deaths by day, minimum 1
```{r}
deaths_daily <- countyonlytoday %>% 
  filter(New_Deaths_Today >=1) %>% 
  select(County_Name, New_Deaths_Today) %>% 
  arrange(desc(New_Deaths_Today))
write.csv(deaths_daily, "deaths_daily.csv")
```

#--------------------------------------------------------------------------------#
#Weekly Change in Cases slide - through line 81
#--------------------------------------------------------------------------------#
#Set Dates
```{r}
#today's date
today <- Sys.Date()

#NOTE: IF YOU ARE RUNNING THIS A DAY LATE, USE THIS CODE TO WORK PROPERLY
#today <- Sys.Date()-1
#today_county$mydate <-"2020-09-22- THE OLD DATE...."

#yesterday's date
yesterday <- (today-1)

```

```{r}
df1 <- master %>% 
  filter(County_Name=="Arkansas_all_counties")

df1 <- df1 %>%
  mutate(DATE = ymd(Date))
```

#date formatting
```{r}
df1$week <- isoweek(df1$DATE)
df1$month <- month(df1$DATE)
```

#calculations by week
```{r}
newcases <- df1 %>%
  group_by(week) %>%
  summarise(week_newcases = sum(New_Cases_Today, na.rm = TRUE))
```

#import table to name the weeks beginning Monday
```{r}
weeks_numbers <- rio::import("https://raw.githubusercontent.com/profrobwells/CovidFall2020/master/weeks_numbers.csv")

weeks_numbers$Date <- lubridate::mdy(weeks_numbers$Date)
```

#Join with cases; manually change date filter after a week
```{r}
weeklycases <- newcases %>% 
  right_join(weeks_numbers, by=c("week"="Number")) %>% 
  filter(Date<today) %>% 
  distinct() %>% 
  arrange(desc(Date))

weeklycases <- weeklycases %>%
  rename(Weekly_Total_New_Cases = week_newcases, Week_Beginning = Date)

write.csv(weeklycases, "weeklycases.csv")
```

#--------------------------------------------------------------------------------#

#Calculate time series totals and averages; used in:

#--------------------------------------------------------------------------------#
#Statewide story slides: Cases context, Confirmed vs probable slides
#Deaths story slides: Cases per death, New deaths - 7 day avg, Statewide Total Deaths, Pct Inactive/Closed cases resulting in death
#County Changes Today story slides: County Snapshots
```{r}
test <- master %>% 
  group_by(County_Name) %>%
  arrange(County_Name, Date) %>% mutate(New_Cases_7_Day_Avg = slider::slide_dbl(New_Cases_Today, mean, .before =
  6, .after = 0)) %>% 
  mutate(New_Deaths_7_Day_Avg = slider::slide_dbl(New_Deaths_Today, mean, .before =
  6, .after = 0)) %>% 
  mutate(Total_Positives = (Confirmed_Positive + Probable_Positive)) %>% 
  mutate(Active_Cases_Total = (confirmed_active + probable_active)) %>% 
  mutate(Total_Deaths = (confirmed_death + probable_death)) %>% 
  mutate(Cases_Per_Death = Total_Positives / Total_Deaths) %>% 
  ungroup()

test <- test %>% 
  arrange(Date)

test$New_Cases_7_Day_Avg <-round(test$New_Cases_7_Day_Avg, 1)
test$New_Deaths_7_Day_Avg <-round(test$New_Deaths_7_Day_Avg, 1)

#County changes today story: county snapshots 
countysnapshot <- test %>%
  select(County_Name, Date, Active_Cases_Total, Total_Positives, Total_Deaths, Pct_Positive_Cumulative, New_Cases_Today, Active_Cases_10k_Pop) %>% 
  filter(Date>"2020-08-31")
write.csv(countysnapshot, "countysnapshot.csv")

#Use this for Story: Cases Context - could combine with statewide2 if we don't go all the way back to Aug. 1
statewide <- test %>% 
  select(Date, County_Name, New_Cases_Today, New_Cases_7_Day_Avg, Total_Positives, Active_Cases_Total, Total_Deaths, Pct_Deaths_vs_Recoveries) %>% 
  filter(County_Name=="Arkansas_all_counties") %>% 
  filter(Date>="2020-08-01")
write.csv(statewide, "statewide.csv")

#Statewide Story - Confirmed vs Probable slide
statewide2 <- test %>% 
  select(Date, County_Name, confirmed_active, probable_active, confirmed_death, probable_death, Confirmed_Positive, Probable_Positive) %>% 
  filter(County_Name=="Arkansas_all_counties") %>% 
  filter(Date>="2020-09-13")

statewide2 <- statewide2 %>%
  rename(Confirmed_Active = confirmed_active, Probable_Active = probable_active, Confirmed_Death = confirmed_death, Probable_Death = probable_death)

write.csv(statewide2, "statewide2.csv")

#Use this for Deaths: Cases per death & 7day avg new deaths, statewide total deaths
deaths <- test %>% 
  select(Date, County_Name, Total_Positives, Total_Deaths, New_Deaths_7_Day_Avg, New_Deaths_Today, Cases_Per_Death) %>% 
  filter(County_Name=="Arkansas_all_counties") %>% 
  filter(Date>="2020-04-08") 
  

write.csv(deaths, "deaths.csv")
```

#Statewide: Top dates for new cases
```{r}
topcases <- master %>% 
  select(County_Name, Date, New_Cases_Today) %>% 
  filter(County_Name=="Arkansas_all_counties") %>% 
  top_n(10, New_Cases_Today) %>% 
  arrange(desc(New_Cases_Today))
 
write.csv(topcases, "topcases.csv")
```

-**30**

