---
title: "Flourish Sheets- County Changes Today, Statewide, and Deaths Stories"
author: "Katy Seiter and Rob Wells"
date: "10/30/2020"
output: html_document
---

```{r}
library(rio)
library(tidyverse)
library(slider)
library(lubridate)
library(formattable)
```

```{r}
master2 <- rio::import("master_file.csv")

```

#Rename columns
```{r}
master <- master2 %>%
  rename(County_Name = county_nam, Confirmed_Positive = confirmed_pos, Probable_Positive =probable_pos, Confirmed_Negative = confirmed_neg, Probable_Negative = probable_neg, Confirmed_Recoveries = confirmed_recov, Probable_Recoveries = probable_recov, PCR_Positive_Test = pcr_pos_test, PCR_Negative_Tests = pcr_neg_test, Total_Positive_Test = total_pos_test, Total_Negative_Test = total_neg_test)

names(master2)
```

#Homepage Numbers
```{r}
homepage <- master %>% 
  select(County_Name, mydate, New_Cases_Today, New_Deaths_Today, deaths, active_cases) %>% 
 filter(County_Name=="Arkansas_all_counties") %>% 
  filter(mydate==today)

homepage$New_Cases_Today <- accounting(homepage$New_Cases_Today, digits = 0)
homepage$New_Deaths_Today <- accounting(homepage$New_Deaths_Today, digits = 0)
homepage$deaths <- accounting(homepage$deaths, digits = 0)
homepage$active_cases <- accounting(homepage$active_cases, digits = 0)

write.csv(homepage, "homepage.csv")
```

#Only counties, one day calculations - County Changes Story: Active and New cases map, Deaths today by county, Top counties with new cases, Total tests by county, Cases and tests from dashboard, New Cases per 10k pop Slides; - Deaths Story: Total deaths by County Slide
```{r}
countyonlytoday <- master %>% 
  filter(mydate==today) %>% 
  filter(County_Name!="Arkansas_all_counties") %>% 
  filter(County_Name!="MissingCountyInfo")
write.csv(countyonlytoday, "countyonlytoday.csv")
```

#Statewide Story: Weekly Change in Cases slide - through line 81
```{r}
df1 <- master %>% 
  filter(County_Name=="Arkansas_all_counties")

df1 <- df1 %>%
  mutate(DATE = ymd(mydate))
```

#date formatting
```{r}
df1$week <- isoweek(df1$DATE)
df1$month <- month(df1$DATE)
```

#calculations by week
```{r}
newcases <- df1 %>%
  group_by(week) %>%
  summarise(week_newcases = sum(New_Cases_Today, na.rm = TRUE))
```

#import table to name the weeks beginning Monday
```{r}
weeks_numbers <- rio::import("https://raw.githubusercontent.com/profrobwells/CovidFall2020/master/weeks_numbers.csv")

weeks_numbers$Date <- lubridate::mdy(weeks_numbers$Date)
```

#Join with cases; manually change date filter after a week
```{r}
weeklycases <- newcases %>% 
  right_join(weeks_numbers, by=c("week"="Number")) %>% 
  filter(Date<"2020-11-01") %>% 
  distinct() %>% 
  arrange(desc(Date))

write.csv(weeklycases, "weeklycases.csv")
```

#Calculate time series totals and averages; used in:
#Statewide story slides: Cases context, Confirmed vs probable slides
#Deaths story slides: Cases per death, New deaths - 7 day avg, Statewide Total Deaths, Pct Inactive/Closed cases resulting in death
#County Changes Today story slides: County Snapshots
```{r}
test <- master %>% 
  group_by(County_Name) %>%
  arrange(County_Name, mydate) %>% mutate(New_Cases_7_Day_Avg = slider::slide_dbl(New_Cases_Today, mean, .before =
  6, .after = 0)) %>% 
  mutate(New_Deaths_7_Day_Avg = slider::slide_dbl(New_Deaths_Today, mean, .before =
  6, .after = 0)) %>% 
  mutate(Total_Positives = (Confirmed_Positive + Probable_Positive)) %>% 
  mutate(Active_Cases_Total = (confirmed_active + probable_active)) %>% 
  mutate(Total_Deaths = (confirmed_death + probable_death)) %>% 
  mutate(Cases_Per_Death = Total_Positives / Total_Deaths) %>% 
  ungroup()

test <- test %>% 
  arrange(mydate)

test$New_Cases_7_Day_Avg <-round(test$New_Cases_7_Day_Avg, 1)
test$New_Deaths_7_Day_Avg <-round(test$New_Deaths_7_Day_Avg, 1)

#County changes today story: county snapshots 
countysnapshot <- test %>%
  select(County_Name, mydate, Active_Cases_Total, Total_Positives, Total_Deaths, Pct_Positive_Cumulative, New_Cases_Today, Active_Cases_10k_Pop) %>% 
  filter(mydate>"2020-08-31")
write.csv(countysnapshot, "countysnapshot.csv")

#Use this for Story: Cases Context - could combine with statewide2 if we don't go all the way back to Aug. 1
statewide <- test %>% 
  select(mydate, County_Name, New_Cases_Today, New_Cases_7_Day_Avg, Total_Positives, Active_Cases_Total, Total_Deaths, Pct_Deaths_vs_Recoveries) %>% 
  filter(County_Name=="Arkansas_all_counties") %>% 
  filter(mydate>="2020-08-01")
write.csv(statewide, "statewide.csv")

#Statewide Story - Confirmed vs Probable slide
statewide2 <- test %>% 
  select(mydate, County_Name, confirmed_active, probable_active, confirmed_death, probable_death, Confirmed_Positive, Probable_Positive) %>% 
  filter(County_Name=="Arkansas_all_counties") %>% 
  filter(mydate>="2020-09-13")

write.csv(statewide2, "statewide2")

#Use this for Deaths: Cases per death & 7day avg new deaths, statewide total deaths
deaths <- test %>% 
  select(mydate, County_Name, Total_Positives, Total_Deaths, New_Deaths_7_Day_Avg, New_Deaths_Today, Cases_Per_Death) %>% 
  filter(County_Name=="Arkansas_all_counties") %>% 
  filter(mydate>="2020-04-08") %>% 
  

write.csv(deaths, "deaths.csv")
```

#Statewide: Top dates for new cases
```{r}
topcases <- master %>% 
  select(County_Name, mydate, New_Cases_Today) %>% 
  filter(County_Name=="Arkansas_all_counties") %>% 
  top_n(10, New_Cases_Today) %>% 
  arrange(desc(New_Cases_Today))
 
write.csv(topcases, "topcases.csv")
```

-**30**

